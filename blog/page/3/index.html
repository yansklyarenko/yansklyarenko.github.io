
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>.NET, Sitecore and setup development</title>
  <meta name="author" content="Yan Sklyarenko">

  
  <meta name="description" content="Today I’m heading to the Agileee 2009 conference being held in Kiev on September, 18 – 19th. This is rather new field to me – I’ve never &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yansklyarenko.github.io/blog/page/3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title=".NET, Sitecore and setup development" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">.NET, Sitecore and setup development</a></h1>
  
    <h2>This blog is used as a memory dump of random thoughts and interesting facts about different things in the world of IT.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:yansklyarenko.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/17/going-to-agileee-2009/">Going to Agileee 2009</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-09-17T21:36:00+03:00" pubdate data-updated="true">Sep 17<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
<p>Today I’m heading to the <a href="http://agileee.org/">Agileee 2009 conference</a> being held in Kiev on September, 18 – 19th. This is rather new field to me – I’ve never been practicing Agile or Scrum before. We’ll see how it goes. At least, I’m expecting to learn many new and interesting things and see how to apply this in the Modules team.</p>  </div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/08/18/webdirproperties-anonymoususer/">WebDirProperties: AnonymousUser Attribute Is Not Obligatory</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-08-18T23:46:00+03:00" pubdate data-updated="true">Aug 18<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
<p>When you specify a <em>WebDirProperties</em> element to be used by the sites you install (configure) with WiX, you might also want to allow anonymous access to this site. Fortunately, there’s an attribute <em>AnonymousAccess</em>, which being set to ‘yes’ allows anonymous access to IIS web site.</p>  <p>NOTE: If you don’t address any property of “authorization” group (<em>AnonymousAccess, BasicAuthentication, DigestAuthentication, PassportAuthentication</em> or <em>WindowsAuthentication</em>) in your <em>WebDirProperties</em>, the site inherits those from w3svc root. If you set at least one explicitly, you need to set others the way you wish, because WiX defaults might not work for you. </p>  <p>The wix.chm states that “<a href="http://wix.sourceforge.net/manual-wix3/iis_xsd_webdirproperties.htm">When setting this (AnonymousAccess) to &#8216;yes&#8217; you should also provide the user account using the AnonymousUser attribute, and determine what setting to use for the IIsControlledPassword attribute.</a>” But it turns out you are not forced to provide the AnonymousUser attribute and I suppose you never wanted to – you should provide a password as well, but who knows the password of IUSR on a target machine?</p>  <p>Instead, just omit the <em>AnonymousUser</em> attribute and this part of IIS metabase will stay untouched. The username/password will inherit from higher node (again, w3svc). And yes, don’t forget <em>IIsControlledPassword</em>=”yes”.</p>  <p>Hope this helps you tuning the website during the installation.</p>  </div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/08/16/warning-to-vbnet-developers/">A Warning to VB.NET Developers</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-08-16T23:43:00+03:00" pubdate data-updated="true">Aug 16<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
<p>Avoid defining methods with default arguments!</p>  <p>Today I have been exploring the “Member design” chapter of a great book of <a href="http://blogs.msdn.com/kcwalina/">Cwalina</a>/<a href="http://blogs.msdn.com/brada/">Abrams</a> “<a href="http://www.amazon.com/Framework-Design-Guidelines-Conventions-Development/dp/0321545613/ref=dp_ob_title_bk">Framework Design Guidelines</a>”, and found a guideline which shocked me a bit. No, the guideline itself is correct and valuable. I just was never thinking it works like this.</p>  <p>VB.NET has a language feature called default arguments. When you define a method in your class, you can specify default values to the optional parameters to be taken when this parameter is omitted. As far as I understand, this is a kind of alternative to the method overloading. </p>  <p>Consider the following code:</p>  <p><font color="#0000ff">Public Class DefaultValues      <br />&#160;&#160;&#160; Public Function Sum(ByVal a As Integer, Optional ByVal b As Integer =</font> <strong><font color="#ff0000">100</font></strong><font color="#0000ff">)      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; Sum = a + b       <br />&#160;&#160;&#160; End Function       <br />&#160; End Class</font></p>  <p>(I speak C# myself, so excuse me my poor VB ;-))</p>  <p>Let’s say we compile this code into a DLL and we have a client console application to utilize that library:</p>  <p><font color="#0000ff">Module TestDefaultValues      <br />&#160;&#160;&#160; Sub Main()       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; Dim df As DefaultValues.DefaultValues = New DefaultValues.DefaultValues()       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; Console.WriteLine(df.Sum(<strong><font color="#ff0000">55</font></strong>))       <br />&#160;&#160;&#160; End Sub       <br />&#160; End Module</font></p>  <p>Compile everything and run TestDefaultValues.exe. The result is predictable: <strong><font color="#ff0000">155</font></strong>.</p>  <p>Now change the default value from 100 to 200 and compile only the library. DO NOT recompile the client application. Run it again, and it is still <strong><font color="#ff0000">155</font></strong>!</p>  <p>This is why it is strongly not recommended to use default arguments instead of normal method overloading. And this issue is why C# doesn’t expose this technique. </p>  <p>Be careful, VB.NET developers! And long live C#! :-)</p>  </div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/07/19/xslt-inline-blocks-of-managed-code/">XSLT: Inline Blocks of Managed Code</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-07-19T23:24:00+03:00" pubdate data-updated="true">Jul 19<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
<p>It’s not a secret that XSLT supports <a href="http://www.w3.org/TR/xslt11/#define-extension-functions">blocks of code</a>, written in another language, to be used inside the stylesheet. It seems to have been there from the very beginning – at least, <a href="http://www.w3.org/TR/xslt11/">XSLT 1.1</a> understands it. </p>  <p>However, Microsoft enriched this option with their own element, <a href="http://msdn.microsoft.com/en-us/library/ms256042.aspx">msxsl:script</a>. It offers pretty much the same functionality, but you can also write the code in C# or any other language of .NET platform. XSLT gurus might argue that it is superfluous stuff and it is unnecessary in 99% of cases. Well, as for me, XSLT lacks a number of useful functions in the standard library, such as ToLower/ToUpper, EndWith, etc. You never think about such low level things when programming C#, but you often have to invent a wheel trying to do the same with XSLT.</p>  <p>More details can be found in the <a href="http://msdn.microsoft.com/en-us/library/wxaw5z5e.aspx">official documentation</a>, but here is a brief extract:</p>  <ul>   <li>guess an extra prefix and let XSLT processor know about it:      <br />      <br />&lt;xsl:stylesheet version=&quot;1.0&quot;       <br />&#160; xmlns:xsl=&quot;<a href="http://www.w3.org/1999/XSL/Transform&quot;">http://www.w3.org/1999/XSL/Transform&quot;</a>       <br />&#160; xmlns:msxsl=&quot;urn:schemas-microsoft-com:xslt&quot;       <br />&#160; <strong>xmlns:ext=&quot;</strong><a href="http://my.domain.com/ext&quot;"><strong>http://my.domain.com/ext&quot;</strong></a>&gt;       <br />&#160;&#160; &#8230;       <br />&lt;/xsl:stylesheet&gt;       <br />      <br />Also, pay attention how msxsl prefix is defined – it is required to use msxsl:script syntax.       <br /></li>    <li>code your extension function:      <br />      <br />&lt;msxsl:script language=&quot;<strong>C#&quot;</strong> implements-prefix=&quot;<strong>ext</strong>&quot;&gt;       <br />&#160;&#160; public string ToUpper(string inString)       <br />&#160;&#160; {       <br />&#160;&#160;&#160;&#160;&#160; return inString.ToUpper();       <br />&#160;&#160; }       <br />&lt;/msxsl:script&gt;       <br /></li>    <li>and finally use it:      <br />      <br />&lt;xsl:value-of select=&quot;ext:ToUpper(@Name))&quot;/&gt; </li> </ul>  <p>Obviously, it is not a good idea to write lots of code this way. It makes the XSLT stylesheet larger and a bit harder to maintain. And, according to Microsoft, you should “<a href="http://msdn.microsoft.com/en-us/library/ms256042.aspx">avoid script blocks from XSLT files, because they require loading the script engine multiple times</a>”. Actually, if you created an XSLT stylesheet to fill it with tones of .NET code, you’re definitely doing something wrong. But it seems to be good addition to small, but useful “one-line” operations.</p>  <h4>Sitecore and msxsl:script</h4>  <p>If you plan to take advantage of inline blocks of C# code in Sitecore XSL rendering, you’ll have to do one more step. By default, .NET API to handle the XSL transforms disables the possibility to use msxsl:script. It is probably done for security reason. But the web.config of your Sitecore solution contains the setting <strong>EnableXslScripts</strong>, which you can easily set to true and be happy:</p>  <p>&lt;!&#8211;&#160; ENABLE XSLT SCRIPTS    <br />&#160;&#160;&#160;&#160;&#160; Determine whether XSLT script support should be enabled.     <br />&#160;&#160;&#160;&#160;&#160; If script support is not enabled, it will be an error if the XSLT file contains script blocks.     <br />&#160;&#160;&#160;&#160;&#160; <strong>Default value: false</strong>.     <br />&#8211;&gt;     <br />&lt;setting name=&quot;EnableXslScripts&quot; value=&quot;<strong>true</strong>&quot; /&gt; </p>  <p>The performance seems to be the same for this simple code either written in msxsl:script block, or wrapped into <a href="http://sdn.sitecore.net/upload/sitecore6/61/presentation_component_cookbook_sc61_a4.pdf">XSL extension</a>. So, the choice is yours.</p>  <h4>WiX and msxsl:script</h4>  <p>The <a href="http://wix.sourceforge.net/manual-wix3/heat.htm">heat.exe</a> utility of the WiX toolset has an option to run the harvested authoring against XSLT transform. This is a checkpoint when you can mutate the output before it is done. INHO, it is the most powerful extension option of Heat, because you can do anything with the XML fragment in XSLT.</p>  <p>However, it was a bit disappointing to find out the scripts are disabled by default, and it is not customizable, and the easiest way to fix this is to patch Heat itself and prepare custom WiX build. It would be great if this option is available one day in the base, either as a command line argument, or a configuration setting.</p>  <p>That’s it. If you have some experience with this trick, knowing its pros and cons deeper, share it here. And as usual, any comments are welcome.</p>  <p>P.S. this post was written with the help of Windows Live writer :-)</p>  </div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/03/22/validating-source-of-treelist/">Validating the Source of TreeList</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-03-22T21:18:00+02:00" pubdate data-updated="true">Mar 22<span>nd</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
Sitecore 6 validation was designed to validate the field values. Recently, I also found it useful to control the source of the complex field types, like TreeList. In this post, I&#8217;ll explain this option taking the TreeList field type as an example.<div><br /></div><div>I&#8217;m skipping the validation basics here, since this topic is covered by <a href="http://alexeyrusakov.com/sitecoreblog/">Alexey Rusakov</a> in his <a href="http://alexeyrusakov.com/sitecoreblog/2008/07/02/Sitecore+6+Validation+Part+1.aspx">validation series</a>.</div><div><br /></div><div>You can define a number of parameters in the source of TreeList field type. The complete list is described in the paragraph 2.4.2 &#8220;How to Control the List of Items in a Selection Field&#8221; of the <a href="http://sdn5.sitecore.net/upload/sitecore6/datadefinitioncookbook-a4.pdf">Data Definition cookbook</a>. These parameters can filter the available and visible items in the content tree (IncludeTemplatesForSelection, ExcludeItemsForDisplay, etc.), define the tree root (DataSource), control multiple selection (AllowMultipleSelection), etc.</div><div><br /></div><div>But modifying this long list of parameters in a one-line edit field can lead to a simple typos, both in the parameters&#8217; names and values. Let&#8217;s examine how this can be &#8220;solved&#8221; by introducing a source validator.</div><div><br /></div><div>The BaseValidator class, the very root of the validator hierarchy in Sitecore API, has a protected method GetField(), which returns an instance of a Field - the one we validate. Hence, the Source property is also available. We want to validate only complex source here, thus skipping if it is an ID or an item path:</div><div><br /></div><div><div>        protected override ValidatorResult Evaluate()</div><div>        {</div><div>            ValidatorResult result = ValidatorResult.Valid;</div><div><br /></div><div>            Field field = GetField();</div><div>            if (field != null)</div><div>            {</div><div>                string fieldSource = field.Source;</div><div>                if (!string.IsNullOrEmpty(fieldSource) &amp;&amp; !ID.IsID(fieldSource) </div><div>                    &amp;&amp; !fieldSource.StartsWith(&#8220;/&#8221;, StringComparison.InvariantCulture))</div><div>                {</div><div>                    result = EvaluateSourceParameters(fieldSource);</div><div>                }</div><div>            }</div><div><br /></div><div>            return result;</div><div>        }</div><div><br /></div></div><div>Ok, let&#8217;s start the validation from just the verification if the source is &#8220;well-formed&#8221;. It might happen that a certain parameter was left without a value, or a typo was introduced to the well-known name. Sitecore will never throw an error in such a case, but instead you may receive an orphaned field with nothing to choose from. Thus, the simplest validation includes these two checks, otherwise it keeps the name/value pairs for further analysis:</div><div><br /></div><div><div>        ValidatorResult EvaluateSourceParameters(string fieldSource)</div><div>        {</div><div>            SafeDictionary<string> parameters = new SafeDictionary<string>();</string></string></div><div>            string[] sourceParts = fieldSource.Split(&#8216;&amp;&#8217;);</div><div>            foreach (string part in sourceParts)</div><div>            {</div><div>                if (string.IsNullOrEmpty(part))</div><div>                {</div><div>                    continue;</div><div>                }</div><div>                if (!part.Contains(&#8220;=&#8221;) || part.EndsWith(&#8220;=&#8221;))</div><div>                {</div><div>                    Text = string.Format(&#8220;The value is not set for source parameter &#8216;{0}&#8217;&#8221;, part.TrimEnd(&#8216;=&#8217;));</div><div>                    return GetFailedResult(ValidatorResult.Error);</div><div>                }</div><div>                else</div><div>                {</div><div>                    string parameterName = part.Substring(0, part.IndexOf(&#8216;=&#8217;)).ToLower();</div><div>                    if (!sourceParameters.Contains(parameterName))</div><div>                    {</div><div>                        Text = string.Format(&#8220;Unknown source parameter &#8216;{0}&#8217;&#8221;, parameterName);</div><div>                        return GetFailedResult(ValidatorResult.Error);</div><div>                    }</div><div>                    else</div><div>                    {</div><div>                        string parameterValue = part.Substring(part.IndexOf(&#8216;=&#8217;) + 1);</div><div>                        parameters.Add(parameterName, parameterValue);</div><div>                    }</div><div>                }</div><div>            }</div><div>            return EvaluateWellFormedParameters(parameters);</div><div>        }</div><div><br /></div><div>The further validation can go deeper and verify the presence of the specified template or item. The method EvaluateWellFormedParameters in this example just iterates the name/value pairs of parameters and applies a certain validation strategy, for instance:</div><div><br /></div><div><div>        ValidatorResult EvaluateTemplates(string value, Database database)</div><div>        {</div><div>            string[] templates = value.Split(new char[] { &#8216;,&#8217; });</div><div>            foreach (string template in templates)</div><div>            {</div><div>                if (!string.IsNullOrEmpty(template) &amp;&amp; Query.SelectSingleItem(string.Format(&#8220;/sitecore/templates//*[@@key=&#8217;{0}&#8217;]&#8221;, template.ToLower()), database) == null)</div><div>                {</div><div>                    Text = string.Format(&#8220;The template &#8216;{0}&#8217; doesn&#8217;t exist in the &#8216;{1}&#8217; database&#8221;, template, database.Name);</div><div>                    return ValidatorResult.Warning;</div><div>                }</div><div>            }</div><div>            return ValidatorResult.Valid;</div><div>        }</div><div><br /></div><div>I&#8217;m attaching the <a href="http://sites.google.com/site/yshost/Home/files/TreeListSourceValidator.cs">full code of this example</a>. </div><div><br /></div><div>There are several notes to consider:</div><div><ul><li>The DatabaseName parameter is not validated, because Sitecore takes over this. Try specifying DatabaseName=nosuchdb, and press Save</li><li>The parameter names are case-insensitive. This is because the parameters are extracted with the StringUtil.ExtractParameter() method, which ignores the case</li><li>The TreeList field type doesn&#8217;t &#8220;tolower&#8221; the values of IncludeItemsForDisplay and ExcludeItemsForDisplay parameters. Hence, be sure to specify an item key instead of an item name here</li><li>The content tree filter is built out of the &#8220;ForDisplay&#8221; parameters using &#8216;and&#8217; operation. Thus, if IncludeItemsForDisplay contain items of other templates than those specified in IncludeTemplatesForDisplay, this results in an empty tree. This can also be a point of extension of this validator&#8217;s functionality</li></ul><div>Hope anyone finds this article useful. As usual, I would appreciate any comments.</div></div></div></div><div><br /></div></div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/02/extended-logging-options-in-wix-custom/">Extended Logging Options in WiX Custom Actions</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-02T22:46:00+02:00" pubdate data-updated="true">Feb 2<span>nd</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
The best and maybe the only way to find out what&#8217;s going wrong with the installation is investigating the MSI log file. Fortunately, the Windows Installer respects log writing very much. You can find the ways to enable logging and different logging options <a href="http://msdn.microsoft.com/en-us/library/aa370536(VS.85).aspx">here</a>.<div><br /></div><div>The verbose log contains all the information MSI can generate. Though it is really useful when it comes to troubleshooting the failed installation, it is quite hard to read, especially for newbies. Again, fortunately, there&#8217;s a super chapter &#8220;Using the Windows Installer log&#8221; in a super book called <a href="http://www.amazon.com/Definitive-Guide-Windows-Installer-Experts/dp/1590592972">&#8220;The Definitive Guide to Windows Installer&#8221; by Phil Wilson</a>, which guides you through the basics of log file reading and understanding.</div><div><br /></div><div>I used to generate the log file with /L*v options, which means verbose. But, if you use WiX custom actions, it turns out that you can make them logging even more verbose.</div><div><br /></div><div>If you browse the WiX source code, you can find the lines like this in its custom actions:</div><div><br /></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">WcaLog(LOGMSG_STANDARD, &#8220;Error: Cannot locate User.User=&#8217;%S&#8217;&#8221;, wzUser);</span></span><br /></div><div><br /></div><div>The first argument is a logging level. It can be </div><div><ul><li>LOGMSG_STANDARD, which is &#8220;write to log whenever informational logging is enabled&#8221;, which in most cases means &#8220;always&#8221;</li><li>LOGMSG_TRACEONLY, which is &#8220;write to log if this WiX build is a DEBUG build&#8221; (is often used internally to dump CustomActionData contents)<br /></li><li>LOGMSG_VERBOSE, which is &#8220;write to log when LOGVERBOSE&#8221;</li></ul><div>Wait a minute, what does the last option means? I&#8217;ve already set the verbose logging by /L*v, but I don&#8217;t see more entries there. Here is the algorithm WiX CA use to know whether to write a log entry marked as LOGMSG_VERBOSE level:</div><div><ul><li>Check if the LOGVERBOSE property is set (can be set in the command-line since it is public)</li><li>Otherwise, check if the MsiLogging property is set (MSI 4.0+)</li><li>Otherwise, check the <a href="http://msdn.microsoft.com/en-us/library/aa369776(VS.85).aspx">logging policy in the registry</a></li></ul><div><br /></div><div>So, the following is the easiest way in my opinion to make your MSI (WiX-based) log file even more verbose:</div><div><br /></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   msiexec /i package.msi &#8230; LOGVERBOSE=1 /L*v install.log</span></span></div><div><br /></div><div>Hope this helps.<br /></div><div><br /></div><div>P.S. This is just a brief extract of what&#8217;s there in the source code. As usual, code is the best documentation ;-)</div></div></div></div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/01/20/iis-extension-webapppool/">IIS Extension: WebAppPool</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-01-20T22:06:00+02:00" pubdate data-updated="true">Jan 20<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
Another challenge - another piece of fun with WiX. Imagine the following requirement: the installation program must install an application pool on IIS6+ environments; the multiple installed instances should use the same application pool. In other words, the application pool must be created with the first instance installation, and must be removed with the last instance uninstallation. <div><br /></div><div>A special element for maintaining IIS AppPools in IIS extension is called WebAppPool. As usual, we&#8217;ll wrap it into a separate component, so that it is created on install. Later, we&#8217;ll create a special custom action to deceive the standard removing mechanism on uninstall:</div><div><br /></div><div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      &lt;Component DiskId=&#8221;1&#8221; Id=&#8221;CreateIISAppPool&#8221; Guid=&#8221;{YOURGUID-6C5B-4980-AD0B-E32FA2DBC1F4}&#8221; Directory=&#8221;WebsiteFolder&#8221;&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">         &lt;Condition&gt;IISMAJORVERSION &lt;&gt; &#8220;#5&#8221;&lt;/Condition&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">         &lt;iis:WebAppPool Id=&#8221;IISSiteAppPool6&#8221; Name=&#8221;[IISAPPPOOL_NAME]&#8221; MaxWorkerProcesses=&#8221;1&#8221; Identity=&#8221;networkService&#8221; /&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">         &lt;RegistryKey Root=&#8221;HKLM&#8221; Key=&#8221;$(var.ParentKey)&#8221;&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">            &lt;RegistryValue Name=&#8221;IISAppPoolName&#8221; Type=&#8221;string&#8221; Value=&#8221;[IISAPPPOOL_NAME]&#8221;/&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">         &lt;/RegistryKey&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      &lt;/Component&gt;</span></span></div><div><br /></div></div><div>As you can see, the component is installed once the target system has IIS 6+. It creates a WebAppPool with the name provided in IISAPPPOOL_NAME public property. It also writes this name into a registry value, which resides under the instance-specific registry key. </div><div>With this component included into the MSI package, the app pool is created when the first instance is installed, and nothing happens for second and subsequent instances. </div><div><br /></div><div>Let&#8217;s examine the uninstall behavior. The MSI behaves natural - when it meets the component to uninstall, it removes the WebAppPool specified in it. But the IIS extension which performs the actual deletion of app pool, needs the name to be passed in it. So, the only thing we should do is to supply this action with a fake app pool name each time, except for the last instance uninstall.</div><div><br /></div><div>Here is the algorithm:</div><div><ol><li>search the registry for the app pool name as usual<br /></li><li>schedule a special action on unistall after AppSearch, which detects if this is the last instance being uninstalled, and if not, &#8220;breaks&#8221; the app pool name into something non-existent<br /></li></ol><div>The first point is quite straight-forward:</div><div><br /></div><div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      &lt;Property Id=&#8221;IISAPPPOOL_NAME&#8221;&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">         &lt;RegistrySearch Id=&#8221;IISAppPoolName&#8221; Root=&#8221;HKLM&#8221; Key=&#8221;$(var.ParentKey)&#8221; Name=&#8221;IISAppPoolName&#8221; Type=&#8221;raw&#8221; /&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      &lt;/Property&gt;</span></span></div><div><br /></div></div><div>The second one is not natural, like any hack:</div><div><br /></div><div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      [CustomAction]</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      public static ActionResult ChangeWebAppPoolNameToDeceiveUninstall(Session session)</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      {</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">         int numberOfInstalled = 1;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">         foreach (ProductInstallation product in ProductInstallation.GetRelatedProducts(session[&#8220;UpgradeCode&#8221;]))</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">         {</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">            if ((session[&#8220;ProductCode&#8221;] != product.ProductCode) &amp;&amp; product.IsInstalled)</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">            {</span></span></div><div><span class="Apple-style-span"  style="color: rgb(51, 51, 255);  font-size:13px;">               numberOfInstalled++;</span><br /></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">               break;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">            }</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">         }</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);"><br /></span></span></div><div><span class="Apple-style-span"  style="color: rgb(51, 51, 255);  font-size:13px;">         if (numberOfInstalled > 1)</span><br /></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">         {</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">            session[&#8220;IISAPPPOOL_NAME&#8221;] += string.Format(&#8220;|{0}&#8221;, DateTime.Now.ToLongTimeString());</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">         }</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);"><br /></span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">         return ActionResult.Success;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      }</span></span></div><div><br /></div></div><div>It iterates the related products (those sharing the UpgradeCode), and if it finds others installed, except for itself, it changes the app pool name we retrieved from registry into something unique, for instance, appends a unique string.</div><div><br /></div><div>Thus, the IIS custom action which is going to delete the app pool fails to find the one with the provided name, and does nothing. When, otherwise, it is the last instance being uninstalled, the retrieved app pool name remains unchanged, and the app pool is successfully removed.</div><div><br /></div><div>Note that the mentioned action should be <span class="Apple-style-span" style="font-weight: bold;">immediate</span>, should occur <span class="Apple-style-span" style="font-weight: bold;">after</span> AppSearch on <span class="Apple-style-span" style="font-weight: bold;">uninstall</span>.</div><div><br /></div><div>That&#8217;s it! I would appreciate any comments as usual.</div></div></div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/01/19/iis-extension-website/">IIS Extension: WebSite</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-01-19T22:04:00+02:00" pubdate data-updated="true">Jan 19<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
Ok, it&#8217;s time for another portion of the installation fun, now about the IIS web sites.<div><br /></div><div>The IIS extension in WiX is probably the most tricky and unobvious. That&#8217;s my personal impression, of course. But, anyway, it gives you an option to tweak any property of a website, virtual directory or web directory. </div><div><br /></div><div>When installing a web application on Windows XP and thus IIS 5.1, it is natural to create an &#8220;ad hoc&#8221; virtual directory during install and remove it on uninstall. That&#8217;s basically quite common case, but what if the application requires to reside under the site root directly, not virtual directory? </div><div><br /></div><div>In this case the root of the Default Web Site should just be switched to the installation directory - nothing is created on install and nothing is removed on uninstall. Let&#8217;s see how this can be done with WiX IIS extension.</div><div><br /></div><div>The iis:WebSite element has two &#8220;modes&#8221;: if it resides under Component element, it is created during install, otherwise it is there just for reference from other elements. Fortunately, it has a special attribute ConfigureIfExists. Setting it to &#8216;yes&#8217; avoids an attempt to create a new site, configuring the existent one instead:</div><div><br /></div><div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      &lt;Component DiskId=&#8221;1&#8221; Id=&#8221;ModifyIISSite5&#8221; Guid=&#8221;{YOURGUID-2023-4D19-90D2-EE9101C71E44}&#8221; Directory=&#8221;WebsiteFolder&#8221; <span class="Apple-style-span" style="font-weight: bold;">Permanent=&#8221;yes&#8221;</span>&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">         &lt;Condition&gt;IISMAJORVERSION = &#8220;#5&#8221;&lt;/Condition&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">         &lt;iis:WebSite Id=&#8221;IISSite5&#8221; Description=&#8221;[IISSITE_NAME]&#8221; Directory=&#8221;WebsiteFolder&#8221; <span class="Apple-style-span" style="font-weight: bold;">ConfigureIfExists=&#8221;yes&#8221;</span>&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">            &lt;iis:WebAddress Id=&#8221;IISSiteAddress5&#8221; Port=&#8221;[IISSITE_PORT]&#8221;/&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">         &lt;/iis:WebSite&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      &lt;/Component&gt;</span></span></div><div><br /></div></div><div>Note, that in this case you should make sure you specified the existent website data. The website is uniquely identified by the description, port and header. The first is an attribute of a WebSite element itself, others belong to the child mandatory element WebAddress. </div><div><br /></div><div>The previous snippet highlights another attribute as bold - Permanent=&#8221;yes&#8221;. It makes the hosting component <a href="http://msdn.microsoft.com/en-us/library/aa369530(VS.85).aspx">permanent</a>, thus preventing it from being deleted on uninstall. Internally, the Windows Installer engine just keeps an extra reference to this component forever, thus it reference count is never equal to 0.</div><div><br /></div><div>One last thing I&#8217;d like to point your attention to is a component condition. It uses the property called IISMAJORVERSION. This property, as well as another one called IISMINORVERSION, is brought by the IIS extension. They are populated from the target system registry during the AppSearch action. Before using them in your authoring make sure you add a couple of references:</div><div><br /></div><div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">    &lt;PropertyRef Id=&#8221;IISMAJORVERSION&#8221;/&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">    &lt;PropertyRef Id=&#8221;IISMINORVERSION&#8221;/&gt;</span></span></div><div><br /></div></div><div>That&#8217;s it! As usual, any comments are highly appreciated.</div></div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/01/10/attach-detach-database-during/">Attach / Detach Database During Installation</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-01-10T18:19:00+02:00" pubdate data-updated="true">Jan 10<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
It seems I have finally managed to implement full database support in my installation program. And it also seems that I stepped on every rake one could imagine in this area. But, the harder the battle, the sweeter the victory. <div><br /></div><div>I had the following requirements: the application is distributed with the MDF/LDF files, which must be attached during installation and detached during uninstallation. Both Windows and SQL authentication must be supported.</div><div><br /></div><div>Fortunately, the kind WiX developers implemented a wonderful SQL extension. So, let&#8217;s take advantage of the sql:SqlDatabase element. The documentation says, it can be placed either under Component, or under Fragment/Module/Product. In the first case the database will always be created when the component is being installed. This doesn&#8217;t suite our needs with attach, so let&#8217;s stick with another option:</div><div><br /></div><div><span class="Apple-style-span"  style="font-family:arial;"><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;fragment&gt;</span></span></span></div><div><span class="Apple-style-span"  style="font-family:arial;"><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&#8230;</span></span></span></div><div><span class="Apple-style-span"  style="font-family:arial;"><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;sql:sqldatabase id=&#8221;SqlMasterDBWinAuth&#8221; server=&#8221;[SQL_SERVER]&#8221; database=&#8221;master&#8221;/&gt;<br /></span></span></span></div><div><span class="Apple-style-span"  style="font-family:arial;"><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&#8230;</span></span></span></div><div><span class="Apple-style-span"  style="font-family:arial;"><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;/fragment&gt;</span></span></span></div><div><br /></div><div>As you can see, we specify the standard Master database in this element. That&#8217;s because the database must exist on the target computer by the moment Windows Installer tries to connect. This syntax will instruct the custom action to open the connection using currently logged-on Windows account. </div><div><br /></div><div>The next step is to provide the appropriate sql:String elements for attach/detach. It is better to put these elements inside the component which installs MDF/LDF files, but this is not the rule. And if you have different conditions for installing the files and running attach, you&#8217;ll have to move the scripts into a separate component.</div><div><br /></div><div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;Component DiskId=&#8221;1&#8221; Id=&#8221;MSSQLCore&#8221; Guid=&#8221;YOURGUID-4E94-4B28-B995-DCBFD50B9F07&#8221;&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;Condition&gt;YOUR CONDITION GOES HERE&lt;/Condition&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;File Id=&#8221;MSSQLCoreFile&#8221; Name=&#8221;$(var.CoreFileName)&#8221; KeyPath=&#8221;yes&#8221; /&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;File Id=&#8221;MSSQLCoreLogFile&#8221; Name=&#8221;$(var.CoreFileLogName)&#8221; /&gt;</span></span></div><div><span class="Apple-style-span" style="COLOR: rgb(51,51,255)"><div><br /></div><div>&lt;sql:SqlString Id=&#8221;DetachCore&#8221; Sequence=&#8221;1&#8221; ContinueOnError=&#8221;yes&#8221; ExecuteOnUninstall=&#8221;yes&#8221; SqlDb=&#8221;SqlMasterDBWinAuth&#8221; SQL=&#8221;EXEC master.dbo.sp_detach_db @dbname = N&#8217;[INSTANCENAME]Core&#8217;, @skipchecks=N&#8217;true&#8217;&#8221;/&gt;</div><div><br /></div><div>&lt;sql:SqlString Id=&#8221;AttachCore&#8221; Sequence=&#8221;2&#8221; ContinueOnError=&#8221;no&#8221; ExecuteOnInstall=&#8221;yes&#8221; SqlDb=&#8221;SqlMasterDBWinAuth&#8221; SQL=&#8221;CREATE DATABASE [\[][INSTANCENAME]Core[\]] ON ( FILENAME = N&#8217;[DB_FOLDER]$(var.CoreFileName)&#8217; ), ( FILENAME = N&#8217;[DB_FOLDER]$(var.CoreFileLogName)&#8217; ) FOR ATTACH&#8221;/&gt;</div><div><br /></div></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;/Component&gt;</span></span></div><div><br /></div><div>At this point I should mention one reef. An SqlString string element also has an attribute SQLUser. If you provide both SqlDb attribute, pointing to the &#8220;WinAuth&#8221; definition of the database, and SqlUser attribute, pointing to the &#8220;sa user&#8221;, it will lead to unpredictable and very strange behavior. I would avoid this. </div><div><br /></div><div>Ok, now we should take care about the rollback actions: during install and uninstall correspondently. It is obvious that RollbackOnInstall should detach databases, if they got installed before failure, and RollbackOnUnistall should attach the databases back, if the failure occurred during uninstall. </div><div><br /></div><div>Thanks to the hint of Rob Mensching in <a href="http://www.mail-archive.com/wix-users@lists.sourceforge.net/msg18212.html">one of his replies to the WiX mailinglist</a>, I managed to overcome another trick. Right after the database is attached, there is sometimes a connection left to this database. I can see this by opening the SQL Management studio and looking at the database status (Normal). If you detach the database in this moment, it flushes the permissions on a physical file to a logon account only. I didn&#8217;t dig very deep into this, it probably corresponds to the <a href="http://msdn.microsoft.com/en-us/library/ms189128.aspx">rules of permissions change during attach/detach</a>. As a result, the windows installer can&#8217;t access the file afterwards, and the uninstallation is rolled back.</div><div><br /></div><div>To fix this, perform &#8220;SET OFFLINE&#8221; query before detaching the database and you&#8217;ll never face with this behavior again.</div><div><br /></div><div>Thus, the final version will look similar to this:</div><div><br /></div><div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;Component DiskId=&#8221;1&#8221; Id=&#8221;MSSQLCore&#8221; Guid=&#8221;YOURGUID-4E94-4B28-B995-DCBFD50B9F07&#8221;&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;Condition&gt;YOUR CONDITION GOES HERE&lt;/Condition&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;File Id=&#8221;MSSQLCoreFile&#8221; Name=&#8221;$(var.CoreFileName)&#8221; KeyPath=&#8221;yes&#8221; /&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;File Id=&#8221;MSSQLCoreLogFile&#8221; Name=&#8221;$(var.CoreFileLogName)&#8221; /&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)"><br /></span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;sql:SqlString Id=&#8221;RollbackDetachCore&#8221; Sequence=&#8221;1&#8221; ContinueOnError=&#8221;yes&#8221; RollbackOnUninstall=&#8221;yes&#8221; SqlDb=&#8221;SqlMasterDBWinAuth&#8221; SQL=&#8221;CREATE DATABASE [\[][INSTANCENAME]Core[\]] ON ( FILENAME = N&#8217;[DB_FOLDER]$(var.CoreFileName)&#8217; ), ( FILENAME = N&#8217;[DB_FOLDER]$(var.CoreFileLogName)&#8217; ) FOR ATTACH&#8221;/&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;sql:SqlString Id=&#8221;OfflineCoreDatabase&#8221; Sequence=&#8221;2&#8221; ContinueOnError=&#8221;yes&#8221; ExecuteOnUninstall=&#8221;yes&#8221; SqlDb=&#8221;SqlMasterDBWinAuth&#8221; SQL=&#8221;ALTER DATABASE [\[][INSTANCENAME]Core[\]] SET OFFLINE WITH ROLLBACK IMMEDIATE&#8221; /&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;sql:SqlString Id=&#8221;DetachCore&#8221; Sequence=&#8221;3&#8221; ContinueOnError=&#8221;yes&#8221; ExecuteOnUninstall=&#8221;yes&#8221; SqlDb=&#8221;SqlMasterDBWinAuth&#8221; SQL=&#8221;EXEC master.dbo.sp_detach_db @dbname = N&#8217;[INSTANCENAME]Core&#8217;, @skipchecks=N&#8217;true&#8217;&#8221;/&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;sql:SqlString Id=&#8221;RollbackAttachCore&#8221; Sequence=&#8221;4&#8221; ContinueOnError=&#8221;yes&#8221; RollbackOnInstall=&#8221;yes&#8221; SqlDb=&#8221;SqlMasterDBWinAuth&#8221; SQL=&#8221;EXEC master.dbo.sp_detach_db @dbname = N&#8217;[INSTANCENAME]Core&#8217;, @skipchecks=N&#8217;true&#8217;&#8221;/&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;sql:SqlString Id=&#8221;AttachCore&#8221; Sequence=&#8221;5&#8221; ContinueOnError=&#8221;no&#8221; ExecuteOnInstall=&#8221;yes&#8221; SqlDb=&#8221;SqlMasterDBWinAuth&#8221; SQL=&#8221;CREATE DATABASE [\[][INSTANCENAME]Core[\]] ON ( FILENAME = N&#8217;[DB_FOLDER]$(var.CoreFileName)&#8217; ), ( FILENAME = N&#8217;[DB_FOLDER]$(var.CoreFileLogName)&#8217; ) FOR ATTACH&#8221;/&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)"><br /></span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;/Component&gt;</span></span></div><div><br /></div></div><div>Ok, but what about Sql Authentication? Well, this requires some kind of duplicating the code. The SqlDb attribute of the SqlString element can&#8217;t accept MSI properties, thus can&#8217;t be dinamically changed during runtime. We must author another element SqlDatabase for referencing it from another set of scripts.</div><div><br /></div><div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;util:User Id=&#8221;SQLUser&#8221; Name=&#8221;[SC_SQL_SERVER_USER]&#8221; Password=&#8221;[SC_SQL_SERVER_PASSWORD]&#8221;/&gt;</span></span></div><div><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;sql:SqlDatabase Id=&#8221;SqlMasterDBWinAuth&#8221; Server=&#8221;[SC_SQL_SERVER]&#8221; Database=&#8221;master&#8221; /&gt;</span><br /></div><div><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;sql:SqlDatabase Id=&#8221;SqlMasterDBSqlAuth&#8221; Server=&#8221;[SC_SQL_SERVER]&#8221; Database=&#8221;master&#8221; User=&#8221;SQLUser&#8221; /&gt;</span><br /></div><div><br /></div></div><div>The first element defines a user to connect to the database. In this example, the username and password are read from the public properties. The user is not created, it is just referenced. The second element should be familiar - it was described above. And the last one differs only in one attribute - SQLUser. </div><div>This does the trick: if you want Windows Authentication way to use, reference SqlMasterDBWinAuth in your scripts, otherwise - use SqlMasterDBWinAuth. Obviously, you need another set of the similar SqlString elements in a different component.</div><div><br /></div><div>Tired? The last thing. </div><div><br /></div><div>If you implemented something similar to what I&#8217;ve described, you should have mentioned that in case of Sql Auth the database is attached as read-only. This happens because the SQL service account (NETWORK SERVICE in my case) doesn&#8217;t have enough permissions to the [DB_FOLDER] and files by the moment attach starts. </div><div>No problem, let&#8217;s assign the necessary rights. Put the following snippet into your component which contains the SqlAuth scripts:</div><div><br /></div><div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;CreateFolder&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;util:PermissionEx GenericAll=&#8221;yes&#8221; User=&#8221;NetworkService&#8221; /&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;/CreateFolder&gt;</span></span></div><div><br /></div></div><div>Note: Don&#8217;t forget to reference WIX_ACCOUNT_NETWORKSERVICE property.</div><div><br /></div><div>But, wait, the ShedSecureObjects is scheduled after the InstallSqlData, this doesn&#8217;t help!</div><div>Right, the sequence should also be changed like this:</div><div><br /></div><div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;InstallExecureSequence&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&#8230;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;Custom Action=&#8221;InstallSqlData&#8221; After=&#8221;SchedSecureObjects&#8221;&gt;NOT SKIPINSTALLSQLDATA AND VersionNT &gt; 400&lt;/Custom&gt;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&#8230;</span></span></div><div><span class="Apple-style-span"  style="font-size:small;"><span class="Apple-style-span" style="COLOR: rgb(51,51,255)">&lt;/InstallExecuteSequence&gt;</span></span></div><div><br /></div></div><div>That&#8217;s it! I know, this can&#8217;t seem easy at first glance, but, as for me, it is much more controlled and customizable, than with InstallShield. I might be wrong, though.</div><div><br /></div><div>Good luck! I would appreciate any comments and notes to this.</div></div></div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/12/30/multiple-instance-installations-and/">Multiple Instance Installations and Patching</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-12-30T11:00:00+02:00" pubdate data-updated="true">Dec 30<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
Well, this is the first message to my first weblog, and it should be outstanding by default. :-)<div><br /></div><div>Sometimes, when creating an installation program, it is necessary to support multiple instance installations of the product to one particular computer. This requirement immediately brings the complexity of the installation to the advanced level. A couple of most tricky things to look after are component rules and patching.</div><div><br /></div><div>In order to make your installation &#8220;multi-instance-aware&#8221;, you should author a number of instance transforms in your source. The number of transforms is the number of instances you plan to support (except for the default one, of course). Fortunately, WiX provides very convenient way to do this:</div><div><br /></div><div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);"><span class="Apple-style-span" style="font-family: arial;">   &lt;instancetransforms property=&#8221;ANY_PROPERTY&#8221;&gt;</span></span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);"><span class="Apple-style-span" style="font-family: arial;">      &lt;instance id=&#8221;InstanceId1&#8221; productcode=&#8221;{42A33A91-36B0-4700-A6F5-1289D22F358C}&#8221;/&gt;</span></span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);"><span class="Apple-style-span" style="font-family: arial;">      &lt;instance id=&#8221;InstanceId2&#8221; productcode=&#8221;{68C62C01-D064-4CF0-9239-F5D2FF36BD9A}&#8221;/&gt;</span></span></span></div><div><span class="Apple-style-span" style="color: rgb(51, 51, 255); font-size: 13px;"><span class="Apple-style-span" style="font-family: arial;">      &#8230;</span></span></div><div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);"><span class="Apple-style-span" style="font-family: arial;">   &lt;/instancetransforms&gt;</span></span></span></div><div><br /></div><div>As always with Windows Installer, this is not the end. According to the <a href="http://msdn.microsoft.com/en-us/library/aa367797(VS.85).aspx">MSI documentation about authoring multiple instances</a>, &#8220;To keep the nonfile data of each instance isolated, the base package should collect nonfile data into sets of components for each instance&#8221;. This can be done by authoring a duplicate of each component for each instance, and install conditionally. But it becomes really complex to manage when you have much more than 2 instances, let&#8217;s say, 100. </div><div><br /></div><div>I chose another way. Assuming the fact that each instance should contain the same set of components, but with different GUIDs, we can generate a number of transforms, one per each instance, which change just the GUIDs of all the components. So, the algorithm is similar to this:</div><div><ul><li>copy the MSI package</li><li>use API to query and update the database with new GUIDs for each component</li><li>generate a transform between the copy and original MSI</li><li>drop the copy MSI</li><li>repeat the steps about the number of times as many instances you plan to support</li><li>embed all these transforms into the original MSI</li></ul><div>Obviously, the number of such customization transforms must be equal to the number of instance transforms and the names should be convenient to use. For instance, if you did everything correctly, you should be able to run the installation of new instance as follows:</div><div><br /></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">msiexec /i YourPackage.msi MSINEWINSTANCE=1 TRANSFORMS=:InstanceId1;:ComponentGUIDTransform1.mst &#8230;</span></span></div><div><br /></div><div>This works like a charm in conjunction with an algorithm to detect next available instance and a bootstrapper. </div><div><br /></div><div>Now let&#8217;s turn to the patching. When I browsed the internet for the info about multiple instance installs and patches, I found <a href="http://blog.deploymentengineering.com/2006/10/multiple-instance-msis-and.html">a great post of Christopher Painter</a>. As he says there, one should populate the Targets property of the patch summary info stream with product codes of all the instances, otherwise the patch detects just the default instance. That&#8217;s correct, but, yes, this is not the end of the story.</div><div><br /></div><div>Let&#8217;s take a look at the <a href="http://msdn.microsoft.com/en-us/library/aa370578(VS.85).aspx">patch definition and its contents</a>: &#8220;Patches contain at a minimum, two database transforms and can contain patch files that are stored in the cabinet file stream of the patch package&#8221;. These two transforms contain the target product GUID and updated product GUID each. In the case of simple patching, it is just one GUID of the target product.</div><div><br /></div><div>Hence, in order to be applied to each instance, the patch must contain a pair of transforms for each instance. Unfortunately, it is not supported by WiX torch+pyro approach and we should fall back to the powerful API:</div><div><br /></div><div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   </span><span class="Apple-style-span" style="color: rgb(0, 153, 0);">// dump transform and change its properties</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   string transformFileName = GetNextValidName(transformName, nameSuffix);</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   patch.ExtractTransform(transformName, transformFileName);</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   SummaryInfo info = new SummaryInfo(transformFileName, true);</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   info.RevisionNumber = info.RevisionNumber.Replace(originalProductCode, productCode);</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   info.Persist();</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   info.Close();</span></span></div><div><br /></div></div><div>So, as you can see, we do the following (for each instance and for each of 2 transforms in default patch):</div><div><ul><li>extract transform from the patch package</li><li>change the original product code to this instance product code in summary info</li></ul><div>Afterwards, we must insert these newly created transforms into the _Storages table of the patch package:</div><div><br /></div><div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">using (View insertView = patchForWrite.OpenView(&#8220;INSERT INTO `_Storages` (`Name`,`Data`) VALUES (&#8216;{0}&#8217;, ?)&#8221;, transformFileName))</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">{</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   using (Record record = new Record(1))</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   {</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      record.SetStream(1, new FileStream(transformFileName, FileMode.Open));</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      insertView.Execute(record);</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      patchForWrite.Commit();</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   }</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">}</span></span></div><div><br /></div></div><div>And finally, we should append the product GUID of each instance to the Template property of Summary info (it is shown as Targets with Orca) and the name of each transform to the LastSavedBy property of the Summary info (it is not shown with Orca). Something like this:</div><div><br /></div><div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(0, 153, 0);">// update patch properties</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">if (!patchForWrite.SummaryInfo.Template.Contains(productCode))</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   {</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      patchForWrite.SummaryInfo.Template += &#8220;;&#8221; + productCode;</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   }</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">patchForWrite.SummaryInfo.LastSavedBy += &#8220;;:&#8221; + transformFileName;</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">patchForWrite.SummaryInfo.Persist();</span></span></div><div><br /></div></div><div>That&#8217;s it! Afterwards, the following magic line should work correctly and patch the installed instance of your application:</div><div><br /></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">msiexec /p YourPatch.msp /n {YOURGUID-0002-0000-0000-624474736554} /qb</span></span><br /></div><div><br /></div><div>Good luck deploying! I would appreciate any comments on this.</div></div></div></div></div></div>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/03/25/use-cognitive-services-in-vsts-custom-branch-policies/">Use cognitive services in VSTS custom branch policies</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/02/20/transform-trello-list-into-markdown-file/">Transform Trello list into Markdown file</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/11/06/vsts-and-teamcity-commit-status-publisher/">VSTS and TeamCity Commit Status Publisher</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/27/err-connection-refused/">ERR_CONNECTION_REFUSED</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/24/build-queue-starvation-in-cc-dot-net/">Build queue starvation in CC.NET</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Yan Sklyarenko -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  










  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
