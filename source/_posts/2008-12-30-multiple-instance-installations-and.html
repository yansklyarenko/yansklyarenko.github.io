---
layout: post
title: "Multiple instance installations and patching"
date: 2008-12-30T11:00:00+02:00
comments: false
categories:
 - MSI
 - WiX
 - patching
 - Windows Installer
 - multiple instance
---

<div class='post'>
Well, this is the first message to my first weblog, and it should be outstanding by default. :-)<div><br /></div><div>Sometimes, when creating an installation program, it is necessary to support multiple instance installations of the product to one particular computer. This requirement immediately brings the complexity of the installation to the advanced level. A couple of most tricky things to look after are component rules and patching.</div><div><br /></div><div>In order to make your installation "multi-instance-aware", you should author a number of instance transforms in your source. The number of transforms is the number of instances you plan to support (except for the default one, of course). Fortunately, WiX provides very convenient way to do this:</div><div><br /></div><div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);"><span class="Apple-style-span" style="font-family: arial;">   &lt;instancetransforms property="ANY_PROPERTY"&gt;</span></span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);"><span class="Apple-style-span" style="font-family: arial;">      &lt;instance id="InstanceId1" productcode="{42A33A91-36B0-4700-A6F5-1289D22F358C}"/&gt;</span></span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);"><span class="Apple-style-span" style="font-family: arial;">      &lt;instance id="InstanceId2" productcode="{68C62C01-D064-4CF0-9239-F5D2FF36BD9A}"/&gt;</span></span></span></div><div><span class="Apple-style-span" style="color: rgb(51, 51, 255); font-size: 13px;"><span class="Apple-style-span" style="font-family: arial;">      ...</span></span></div><div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);"><span class="Apple-style-span" style="font-family: arial;">   &lt;/instancetransforms&gt;</span></span></span></div><div><br /></div><div>As always with Windows Installer, this is not the end. According to the <a href="http://msdn.microsoft.com/en-us/library/aa367797(VS.85).aspx">MSI documentation about authoring multiple instances</a>, "To keep the nonfile data of each instance isolated, the base package should collect nonfile data into sets of components for each instance". This can be done by authoring a duplicate of each component for each instance, and install conditionally. But it becomes really complex to manage when you have much more than 2 instances, let's say, 100. </div><div><br /></div><div>I chose another way. Assuming the fact that each instance should contain the same set of components, but with different GUIDs, we can generate a number of transforms, one per each instance, which change just the GUIDs of all the components. So, the algorithm is similar to this:</div><div><ul><li>copy the MSI package</li><li>use API to query and update the database with new GUIDs for each component</li><li>generate a transform between the copy and original MSI</li><li>drop the copy MSI</li><li>repeat the steps about the number of times as many instances you plan to support</li><li>embed all these transforms into the original MSI</li></ul><div>Obviously, the number of such customization transforms must be equal to the number of instance transforms and the names should be convenient to use. For instance, if you did everything correctly, you should be able to run the installation of new instance as follows:</div><div><br /></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">msiexec /i YourPackage.msi MSINEWINSTANCE=1 TRANSFORMS=:InstanceId1;:ComponentGUIDTransform1.mst ...</span></span></div><div><br /></div><div>This works like a charm in conjunction with an algorithm to detect next available instance and a bootstrapper. </div><div><br /></div><div>Now let's turn to the patching. When I browsed the internet for the info about multiple instance installs and patches, I found <a href="http://blog.deploymentengineering.com/2006/10/multiple-instance-msis-and.html">a great post of Christopher Painter</a>. As he says there, one should populate the Targets property of the patch summary info stream with product codes of all the instances, otherwise the patch detects just the default instance. That's correct, but, yes, this is not the end of the story.</div><div><br /></div><div>Let's take a look at the <a href="http://msdn.microsoft.com/en-us/library/aa370578(VS.85).aspx">patch definition and its contents</a>: "Patches contain at a minimum, two database transforms and can contain patch files that are stored in the cabinet file stream of the patch package". These two transforms contain the target product GUID and updated product GUID each. In the case of simple patching, it is just one GUID of the target product.</div><div><br /></div><div>Hence, in order to be applied to each instance, the patch must contain a pair of transforms for each instance. Unfortunately, it is not supported by WiX torch+pyro approach and we should fall back to the powerful API:</div><div><br /></div><div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   </span><span class="Apple-style-span" style="color: rgb(0, 153, 0);">// dump transform and change its properties</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   string transformFileName = GetNextValidName(transformName, nameSuffix);</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   patch.ExtractTransform(transformName, transformFileName);</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   SummaryInfo info = new SummaryInfo(transformFileName, true);</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   info.RevisionNumber = info.RevisionNumber.Replace(originalProductCode, productCode);</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   info.Persist();</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   info.Close();</span></span></div><div><br /></div></div><div>So, as you can see, we do the following (for each instance and for each of 2 transforms in default patch):</div><div><ul><li>extract transform from the patch package</li><li>change the original product code to this instance product code in summary info</li></ul><div>Afterwards, we must insert these newly created transforms into the _Storages table of the patch package:</div><div><br /></div><div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">using (View insertView = patchForWrite.OpenView("INSERT INTO `_Storages` (`Name`,`Data`) VALUES ('{0}', ?)", transformFileName))</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">{</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   using (Record record = new Record(1))</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   {</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      record.SetStream(1, new FileStream(transformFileName, FileMode.Open));</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      insertView.Execute(record);</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      patchForWrite.Commit();</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   }</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">}</span></span></div><div><br /></div></div><div>And finally, we should append the product GUID of each instance to the Template property of Summary info (it is shown as Targets with Orca) and the name of each transform to the LastSavedBy property of the Summary info (it is not shown with Orca). Something like this:</div><div><br /></div><div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(0, 153, 0);">// update patch properties</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">if (!patchForWrite.SummaryInfo.Template.Contains(productCode))</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   {</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">      patchForWrite.SummaryInfo.Template += ";" + productCode;</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">   }</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">patchForWrite.SummaryInfo.LastSavedBy += ";:" + transformFileName;</span></span></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">patchForWrite.SummaryInfo.Persist();</span></span></div><div><br /></div></div><div>That's it! Afterwards, the following magic line should work correctly and patch the installed instance of your application:</div><div><br /></div><div><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: rgb(51, 51, 255);">msiexec /p YourPatch.msp /n {YOURGUID-0002-0000-0000-624474736554} /qb</span></span><br /></div><div><br /></div><div>Good luck deploying! I would appreciate any comments on this.</div></div></div></div></div></div>
