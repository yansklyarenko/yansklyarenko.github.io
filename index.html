
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>.NET, Sitecore and setup development</title>
  <meta name="author" content="Yan Sklyarenko">

  
  <meta name="description" content="Imagine a situation when an international distributed team works on a project. People speak different languages and often tend to add comments or &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yansklyarenko.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title=".NET, Sitecore and setup development" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">.NET, Sitecore and setup development</a></h1>
  
    <h2>This blog is used as a memory dump of random thoughts and interesting facts about different things in the world of IT.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:yansklyarenko.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/03/25/use-cognitive-services-in-vsts-custom-branch-policies/">Use Cognitive Services in VSTS Custom Branch Policies</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-03-25T10:53:00+03:00" pubdate data-updated="true">Mar 25<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Imagine a situation when an international distributed team works on a project. People speak different languages and often tend to add comments or name things in their native language. What if we can configure a system which analyzes the pull request contents and prevents its completion unless it is in English? Fortunately, it is possible with Microsoft cognitive services API, Azure functions and custom branch policies in VSTS. Let&rsquo;s walk through the process.</p>

<p>There is a detailed article on <a href="https://docs.microsoft.com/en-us/vsts/git/how-to/create-pr-status-server-with-azure-functions">how to use Azure functions to create custom branch policies</a>. I will use it as a starting point.</p>

<p>First of all, let&rsquo;s remove some simplifications, like hard-coded VSTS PAT and later cognitive serivces API key. Those entities can be kept in the Azure key vault as secrets and safely addressed from the Azure function code.</p>

<p>Then, let&rsquo;s replace the primitive sample &ldquo;starts with [WIP]&rdquo; check in that sample above with some more sophisticated verification. I&rsquo;ll use Microsoft cognitive services to detect the language of the pull request title. In case the language confidence is higher than 70% I&rsquo;ll assume the text is in English.</p>

<p>Finally, let&rsquo;s post proper pull request status and configure branching policy out of that status, and see how the full solution works.</p>

<h2>Keep code secrets in the Azure Key Vault service and access those from Azure Function</h2>

<p>There are official docs about <a href="https://docs.microsoft.com/en-us/azure/azure-stack/user/azure-stack-kv-manage-portal">how to get started with the key vault service</a>. We&rsquo;ll need to create 2 secrets: one for VSTS personal access token (PAT) and another one for API key to be used when connecting to cognitive services. The &ldquo;create a secret&rdquo; section under <a href="https://docs.microsoft.com/en-us/azure/azure-stack/user/azure-stack-kv-manage-portal#manage-keys-and-secrets">Manage keys and secrets</a> gives a step-by-step guideline on how to do this. Note that <em>Secret Identifier</em> field &ndash; it is required to get the secret value from inside the Azure function code.</p>

<p><img src="/images/march2018/azure_key_vault_secrets.png"></p>

<p>Now we need to grant our Azure function permissions to read the secrets from the key vault. <a href="https://medium.com/statuscode/getting-key-vault-secrets-in-azure-functions-37620fd20a0b">This great article</a> contains detailed steps on how to achieve this. To tell it short, there are two major points:</p>

<h3>Enable Managed Service Identiry for the Function App</h3>

<p>As far as I understand, it will make the function app appear as an AD identity for Azure and it will be possible to grant permissions specifically to the function as if it is done for a normal user:</p>

<p><img src="/images/march2018/enable_managed_service_identiry.png"></p>

<h3>Add an access policy in the key vault for the Azure function</h3>

<p>This will allow the function app to read the secrets in the key vault. The access policy contains a variaty of permissions, but for this sample only <em>Get</em> and <em>List</em> under <em>Secret Management Operations</em> are required:</p>

<p><img src="/images/march2018/add_access_policy.png"></p>

<h3>Access key vault secrets from the Azure function</h3>

<p>The API required for that reside in the following two NuGet packages, that should be added to the <em>project.json</em> file of the function:</p>

<p><img src="/images/march2018/project_json_keyvault.png"></p>

<p>Then the code itself it quite trivial:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">using</span> <span class="nn">Microsoft.Azure.KeyVault</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">Microsoft.Azure.Services.AppAuthentication</span><span class="p">;</span>
</span><span class='line'><span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'><span class="kt">var</span> <span class="n">azureServiceTokenProvider</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AzureServiceTokenProvider</span><span class="p">();</span>
</span><span class='line'><span class="kt">var</span> <span class="n">kvClient</span> <span class="p">=</span> <span class="k">new</span> <span class="n">KeyVaultClient</span><span class="p">(</span><span class="k">new</span> <span class="n">KeyVaultClient</span><span class="p">.</span><span class="n">AuthenticationCallback</span><span class="p">(</span><span class="n">azureServiceTokenProvider</span><span class="p">.</span><span class="n">KeyVaultTokenCallback</span><span class="p">));</span>
</span><span class='line'><span class="kt">string</span> <span class="n">vstsPAT</span> <span class="p">=</span> <span class="p">(</span><span class="k">await</span> <span class="n">kvClient</span><span class="p">.</span><span class="n">GetSecretAsync</span><span class="p">(</span><span class="s">&quot;https://ysmainkeyvault.vault.azure.net/secrets/vstsPAT/&lt;GUID_HERE&gt;&quot;</span><span class="p">)).</span><span class="n">Value</span><span class="p">;</span>
</span><span class='line'><span class="kt">string</span> <span class="n">apiKey</span> <span class="p">=</span> <span class="p">(</span><span class="k">await</span> <span class="n">kvClient</span><span class="p">.</span><span class="n">GetSecretAsync</span><span class="p">(</span><span class="s">&quot;https://ysmainkeyvault.vault.azure.net/secrets/CognitiveServicesAPIkey/&lt;GUID_HERE&gt;&quot;</span><span class="p">)).</span><span class="n">Value</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <em>&lt;GUID_HERE></em> token above should be replaced with the real Secret Identifier of each secret.</p>

<h2>Use Microsoft cognitive services to detect the language of the pull request title</h2>

<p><a href="https://azure.microsoft.com/en-us/services/cognitive-services/">Microsoft cognitive services</a> is a bunch of AI-driven Azure services which can do much more than just text analytics. In this article we&rsquo;ll just touch the surface with language part of it. I can higly recommend the <a href="https://app.pluralsight.com/library/courses/microsoft-cognitive-services-text-analytics-api/table-of-contents">Microsoft Cognitive Services: Text Analytics API</a> course on Pluralsight by <a href="http://twitter.com/MCKRUZ">Matt Kruczek</a> if you want to learn some more. In fact, I&rsquo;ll use slightly modified example from that course in this article.</p>

<p>To begin with, a new resource should be instantiated in Azure: Text Analytics API. It is important to choose West US as a location here, no matter which one is closer to you. For some reason, the C# API we&rsquo;ll work with (from Microsoft.ProjectOxford.Text NuGet package) addresses West US API endpoint. <a href="https://stackoverflow.com/a/47961098/274535">This StackOverflow answer</a> helped to understand the root cause.</p>

<p>Once the resource is created, make sure to get the API key (KEY 1 on the image below) and place it to the key vault:</p>

<p><img src="/images/march2018/text_analytics_keys.png"></p>

<p>As I mentioned above, the Microsoft.ProjectOxford.Text NuGet package is to be used to talk to the language analytics service. Let&rsquo;s add this NuGet package to the <em>project.json</em> of the function, too:</p>

<p><img src="/images/march2018/project_json_oxford.png"></p>

<p>Finally, the code itself is placed in the private method, which is called from the main function each time we need to detect the language of the text:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">GetEnglishConfidence</span><span class="p">(</span><span class="kt">string</span> <span class="n">text</span><span class="p">,</span> <span class="kt">string</span> <span class="n">apiKey</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">document</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Document</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Id</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">().</span><span class="n">ToString</span><span class="p">(),</span>
</span><span class='line'>        <span class="n">Text</span> <span class="p">=</span> <span class="n">text</span><span class="p">,</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">englishConfidence</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LanguageClient</span><span class="p">(</span><span class="n">apiKey</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">request</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LanguageRequest</span><span class="p">();</span>
</span><span class='line'>    <span class="n">request</span><span class="p">.</span><span class="n">Documents</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">document</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">GetLanguages</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">var</span> <span class="n">tryEnglish</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">Documents</span><span class="p">.</span><span class="n">First</span><span class="p">().</span><span class="n">DetectedLanguages</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">l</span> <span class="p">=&gt;</span> <span class="n">l</span><span class="p">.</span><span class="n">Iso639Name</span> <span class="p">==</span> <span class="s">&quot;en&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">tryEnglish</span><span class="p">.</span><span class="n">Any</span><span class="p">())</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">english</span> <span class="p">=</span> <span class="n">tryEnglish</span><span class="p">.</span><span class="n">First</span><span class="p">();</span>
</span><span class='line'>            <span class="n">englishConfidence</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">english</span><span class="p">.</span><span class="n">Score</span> <span class="p">*</span> <span class="m">100</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">englishConfidence</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that it is all about sending proper request, and then finding out the language score of the detected languages in the response.</p>

<h2>Post pull request status back to VSTS pull request</h2>

<p>The original guideline I referenced at the beginning of this article contains the code of one other helper method we are going to change: <em>ComputeStatus</em>. Our version of this method will make a call to <em>GetEnglishConfidence</em> method listed above and form proper JSON to post back to VSTS:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">ComputeStatus</span><span class="p">(</span><span class="kt">string</span> <span class="n">pullRequestTitle</span><span class="p">,</span> <span class="kt">string</span> <span class="n">apiKey</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">string</span> <span class="n">state</span> <span class="p">=</span> <span class="s">&quot;failed&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">string</span> <span class="n">description</span> <span class="p">=</span> <span class="s">&quot;The PR title is not in English&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">GetEnglishConfidence</span><span class="p">(</span><span class="n">pullRequestTitle</span><span class="p">,</span> <span class="n">apiKey</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span> <span class="p">&gt;=</span> <span class="m">70</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">state</span> <span class="p">=</span> <span class="s">&quot;succeeded&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="n">description</span> <span class="p">=</span> <span class="s">&quot;The PR title is in English! Please, proceed!&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="n">SerializeObject</span><span class="p">(</span>
</span><span class='line'>        <span class="k">new</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">State</span> <span class="p">=</span> <span class="n">state</span><span class="p">,</span>
</span><span class='line'>            <span class="n">Description</span> <span class="p">=</span> <span class="n">description</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">Context</span> <span class="p">=</span> <span class="k">new</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;AIforCI&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">Genre</span> <span class="p">=</span> <span class="s">&quot;pr-azure-function-ci&quot;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Besides, as long as the call to the language analytics service might take some time, we need a method to post initial Pending status:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">ComputeInitialStatus</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">string</span> <span class="n">state</span> <span class="p">=</span> <span class="s">&quot;pending&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">string</span> <span class="n">description</span> <span class="p">=</span> <span class="s">&quot;Verifying title language&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="n">SerializeObject</span><span class="p">(</span>
</span><span class='line'>        <span class="k">new</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">State</span> <span class="p">=</span> <span class="n">state</span><span class="p">,</span>
</span><span class='line'>            <span class="n">Description</span> <span class="p">=</span> <span class="n">description</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">Context</span> <span class="p">=</span> <span class="k">new</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;AIforCI&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">Genre</span> <span class="p">=</span> <span class="s">&quot;pr-azure-function-ci&quot;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As a result, the most interesting part of the Azure function itself will look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="c1">// Post the initial status (pending) while the true one is calculated</span>
</span><span class='line'><span class="n">PostStatusOnPullRequest</span><span class="p">(</span><span class="n">pullRequestId</span><span class="p">,</span> <span class="n">ComputeInitialStatus</span><span class="p">(),</span> <span class="n">vstsPAT</span><span class="p">);</span>
</span><span class='line'><span class="c1">// Post the real status based on the language analysis</span>
</span><span class='line'><span class="n">PostStatusOnPullRequest</span><span class="p">(</span><span class="n">pullRequestId</span><span class="p">,</span> <span class="n">ComputeStatus</span><span class="p">(</span><span class="n">pullRequestTitle</span><span class="p">,</span> <span class="n">apiKey</span><span class="p">,</span> <span class="n">log</span><span class="p">),</span> <span class="n">vstsPAT</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Demo time: let&rsquo;s tie it all together</h2>

<p>I&rsquo;ll assume that all the steps described in the <a href="(https://docs.microsoft.com/en-us/vsts/git/how-to/create-pr-status-server-with-azure-functions">original guideline about Azure functions and pull requests</a>) are completed properly. As a result, VSTS knows how to trigger our Azure function on pull request create and update events.</p>

<p>Let&rsquo;s create the first pull request and let it be titled in pure English:</p>

<p><img src="/images/march2018/new_pr_pending.png"></p>

<p>As soon as the title is verified against the language analytics service, the status changes:</p>

<p><img src="/images/march2018/new_pr_success.png"></p>

<p>Now, if we try to modify the title to some Russian text, the status changes accordingly:</p>

<p><img src="/images/march2018/new_pr_failure.png"></p>

<p>Finally, we can <a href="https://docs.microsoft.com/en-us/vsts/git/how-to/pr-status-policy?view=vsts">make a policy out of the pull request status</a>, and decide whether to block the PR completion based on the language verification result:</p>

<p><img src="/images/march2018/new_pr_policy_success.png"></p>

<h2>Conclusion</h2>

<p>The combination of custom branch policies in VSTS and the power of Azure functions might result in very flexible solutions, limited only by your imagination. Give it a try and tweak your gated CI to comply with your needs.</p>

<p>Here is the full source code of the solution:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="err">#</span><span class="n">r</span> <span class="s">&quot;Newtonsoft.Json&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Net.Http</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Net.Http.Headers</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">Newtonsoft.Json</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">Microsoft.Azure.KeyVault</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">Microsoft.Azure.Services.AppAuthentication</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">Microsoft.ProjectOxford.Text.Core</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">Microsoft.ProjectOxford.Text.Language</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">accountName</span> <span class="p">=</span> <span class="s">&quot;[Account Name]&quot;</span><span class="p">;</span>   <span class="c1">// Account name</span>
</span><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">projectName</span> <span class="p">=</span> <span class="s">&quot;[Project Name]&quot;</span><span class="p">;</span>   <span class="c1">// Project name</span>
</span><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">repositoryName</span> <span class="p">=</span> <span class="s">&quot;[Repo Name]&quot;</span><span class="p">;</span>   <span class="c1">// Repository name</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="n">Run</span><span class="p">(</span><span class="n">HttpRequestMessage</span> <span class="n">req</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">try</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="s">&quot;Service Hook Received.&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Get secrets from key vault</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">azureServiceTokenProvider</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AzureServiceTokenProvider</span><span class="p">();</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">kvClient</span> <span class="p">=</span> <span class="k">new</span> <span class="n">KeyVaultClient</span><span class="p">(</span><span class="k">new</span> <span class="n">KeyVaultClient</span><span class="p">.</span><span class="n">AuthenticationCallback</span><span class="p">(</span><span class="n">azureServiceTokenProvider</span><span class="p">.</span><span class="n">KeyVaultTokenCallback</span><span class="p">));</span>
</span><span class='line'>        <span class="kt">string</span> <span class="n">vstsPAT</span> <span class="p">=</span> <span class="p">(</span><span class="k">await</span> <span class="n">kvClient</span><span class="p">.</span><span class="n">GetSecretAsync</span><span class="p">(</span><span class="s">&quot;https://ysmainkeyvault.vault.azure.net/secrets/vstsPAT/&lt;GUID_HERE&gt;&quot;</span><span class="p">)).</span><span class="n">Value</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">string</span> <span class="n">apiKey</span> <span class="p">=</span> <span class="p">(</span><span class="k">await</span> <span class="n">kvClient</span><span class="p">.</span><span class="n">GetSecretAsync</span><span class="p">(</span><span class="s">&quot;https://ysmainkeyvault.vault.azure.net/secrets/CognitiveServicesAPIkey/&lt;GUID_HERE&gt;&quot;</span><span class="p">)).</span><span class="n">Value</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Get request body</span>
</span><span class='line'>        <span class="kt">dynamic</span> <span class="n">data</span> <span class="p">=</span> <span class="k">await</span> <span class="n">req</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="n">ReadAsAsync</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="s">&quot;Data Received: &quot;</span> <span class="p">+</span> <span class="n">data</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Get the pull request object from the service hooks payload</span>
</span><span class='line'>        <span class="kt">dynamic</span> <span class="n">jObject</span> <span class="p">=</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="n">DeserializeObject</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Get the pull request id</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">pullRequestId</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(!</span><span class="n">Int32</span><span class="p">.</span><span class="n">TryParse</span><span class="p">(</span><span class="n">jObject</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">pullRequestId</span><span class="p">.</span><span class="n">ToString</span><span class="p">(),</span> <span class="k">out</span> <span class="n">pullRequestId</span><span class="p">))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="s">&quot;Failed to parse the pull request id from the service hooks payload.&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Get the pull request title</span>
</span><span class='line'>        <span class="kt">string</span> <span class="n">pullRequestTitle</span> <span class="p">=</span> <span class="n">jObject</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">title</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="s">&quot;Service Hook Received for PR: &quot;</span> <span class="p">+</span> <span class="n">pullRequestId</span> <span class="p">+</span> <span class="s">&quot; &quot;</span> <span class="p">+</span> <span class="n">pullRequestTitle</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Post the initial status (pending) while the true one is calculated</span>
</span><span class='line'>        <span class="n">PostStatusOnPullRequest</span><span class="p">(</span><span class="n">pullRequestId</span><span class="p">,</span> <span class="n">ComputeInitialStatus</span><span class="p">(),</span> <span class="n">vstsPAT</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">// Post the real status based on the language analysis</span>
</span><span class='line'>        <span class="n">PostStatusOnPullRequest</span><span class="p">(</span><span class="n">pullRequestId</span><span class="p">,</span> <span class="n">ComputeStatus</span><span class="p">(</span><span class="n">pullRequestTitle</span><span class="p">,</span> <span class="n">apiKey</span><span class="p">,</span> <span class="n">log</span><span class="p">),</span> <span class="n">vstsPAT</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">req</span><span class="p">.</span><span class="n">CreateResponse</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">req</span><span class="p">.</span><span class="n">CreateResponse</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">InternalServerError</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">PostStatusOnPullRequest</span><span class="p">(</span><span class="kt">int</span> <span class="n">pullRequestId</span><span class="p">,</span> <span class="kt">string</span> <span class="n">status</span><span class="p">,</span> <span class="kt">string</span> <span class="n">pat</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">string</span> <span class="n">Url</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span>
</span><span class='line'>        <span class="s">@&quot;https://{0}.visualstudio.com/{1}/_apis/git/repositories/{2}/pullrequests/{3}/statuses?api-version=4.0-preview&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">accountName</span><span class="p">,</span>
</span><span class='line'>        <span class="n">projectName</span><span class="p">,</span>
</span><span class='line'>        <span class="n">repositoryName</span><span class="p">,</span>
</span><span class='line'>        <span class="n">pullRequestId</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">using</span> <span class="p">(</span><span class="n">HttpClient</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpClient</span><span class="p">())</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">client</span><span class="p">.</span><span class="n">DefaultRequestHeaders</span><span class="p">.</span><span class="n">Accept</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">MediaTypeWithQualityHeaderValue</span><span class="p">(</span><span class="s">&quot;application/json&quot;</span><span class="p">));</span>
</span><span class='line'>        <span class="n">client</span><span class="p">.</span><span class="n">DefaultRequestHeaders</span><span class="p">.</span><span class="n">Authorization</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AuthenticationHeaderValue</span><span class="p">(</span><span class="s">&quot;Basic&quot;</span><span class="p">,</span> <span class="n">Convert</span><span class="p">.</span><span class="n">ToBase64String</span><span class="p">(</span>
</span><span class='line'>                <span class="n">ASCIIEncoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span>
</span><span class='line'>                <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;{0}:{1}&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">pat</span><span class="p">))));</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">var</span> <span class="n">method</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpMethod</span><span class="p">(</span><span class="s">&quot;POST&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">request</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpRequestMessage</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">Url</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Content</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringContent</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">,</span> <span class="s">&quot;application/json&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">using</span> <span class="p">(</span><span class="n">HttpResponseMessage</span> <span class="n">response</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">request</span><span class="p">).</span><span class="n">Result</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">response</span><span class="p">.</span><span class="n">EnsureSuccessStatusCode</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">GetEnglishConfidence</span><span class="p">(</span><span class="kt">string</span> <span class="n">text</span><span class="p">,</span> <span class="kt">string</span> <span class="n">apiKey</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">document</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Document</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Id</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">().</span><span class="n">ToString</span><span class="p">(),</span>
</span><span class='line'>        <span class="n">Text</span> <span class="p">=</span> <span class="n">text</span><span class="p">,</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">englishConfidence</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LanguageClient</span><span class="p">(</span><span class="n">apiKey</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">request</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LanguageRequest</span><span class="p">();</span>
</span><span class='line'>    <span class="n">request</span><span class="p">.</span><span class="n">Documents</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">document</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">GetLanguages</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">var</span> <span class="n">tryEnglish</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">Documents</span><span class="p">.</span><span class="n">First</span><span class="p">().</span><span class="n">DetectedLanguages</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">l</span> <span class="p">=&gt;</span> <span class="n">l</span><span class="p">.</span><span class="n">Iso639Name</span> <span class="p">==</span> <span class="s">&quot;en&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">tryEnglish</span><span class="p">.</span><span class="n">Any</span><span class="p">())</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">english</span> <span class="p">=</span> <span class="n">tryEnglish</span><span class="p">.</span><span class="n">First</span><span class="p">();</span>
</span><span class='line'>            <span class="n">englishConfidence</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">english</span><span class="p">.</span><span class="n">Score</span> <span class="p">*</span> <span class="m">100</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">log</span><span class="p">.</span><span class="n">Info</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">englishConfidence</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">ComputeInitialStatus</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">string</span> <span class="n">state</span> <span class="p">=</span> <span class="s">&quot;pending&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">string</span> <span class="n">description</span> <span class="p">=</span> <span class="s">&quot;Verifying title language&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="n">SerializeObject</span><span class="p">(</span>
</span><span class='line'>        <span class="k">new</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">State</span> <span class="p">=</span> <span class="n">state</span><span class="p">,</span>
</span><span class='line'>            <span class="n">Description</span> <span class="p">=</span> <span class="n">description</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">Context</span> <span class="p">=</span> <span class="k">new</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;AIforCI&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">Genre</span> <span class="p">=</span> <span class="s">&quot;pr-azure-function-ci&quot;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">ComputeStatus</span><span class="p">(</span><span class="kt">string</span> <span class="n">pullRequestTitle</span><span class="p">,</span> <span class="kt">string</span> <span class="n">apiKey</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">string</span> <span class="n">state</span> <span class="p">=</span> <span class="s">&quot;failed&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">string</span> <span class="n">description</span> <span class="p">=</span> <span class="s">&quot;The PR title is not in English&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">GetEnglishConfidence</span><span class="p">(</span><span class="n">pullRequestTitle</span><span class="p">,</span> <span class="n">apiKey</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span> <span class="p">&gt;=</span> <span class="m">70</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">state</span> <span class="p">=</span> <span class="s">&quot;succeeded&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="n">description</span> <span class="p">=</span> <span class="s">&quot;The PR title is in English! Please, proceed!&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="n">SerializeObject</span><span class="p">(</span>
</span><span class='line'>        <span class="k">new</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">State</span> <span class="p">=</span> <span class="n">state</span><span class="p">,</span>
</span><span class='line'>            <span class="n">Description</span> <span class="p">=</span> <span class="n">description</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">Context</span> <span class="p">=</span> <span class="k">new</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;AIforCI&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">Genre</span> <span class="p">=</span> <span class="s">&quot;pr-azure-function-ci&quot;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/02/20/transform-trello-list-into-markdown-file/">Transform Trello List Into Markdown File</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-02-20T21:38:00+02:00" pubdate data-updated="true">Feb 20<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I really enjoy reading. And I think I read a lot. I&rsquo;m sure there are people who read much more, but&hellip; well, that&rsquo;s not what I was going to tell you.</p>

<p>One day I realized that some book recommendations I come across got lost in my memory, so I started a special <a href="https://trello.com">Trello</a> board. Basically, when I get a book recommendation from a person I respect, I add a new card to the initial <em>To Read</em> list of that board. When a certain book is read, I write a short review into the Description of the appropriate card and move it to final <em>Done</em> list.</p>

<p><img src="/images/february2018/trello_reading_board.png"></p>

<p>Thus, the <em>Done</em> list gets populated with (quite subjective) book reviews. I thought it might be a good idea to post those reviews as a separate article. One day.</p>

<p>As long as compiling long lists out of dozens small snippets is a boring task, it turns out to be a good occasion to play with the Trello API.</p>

<p>So, the idea is to have a PowerShell script which will iterate over the cards in the list and generate a nice Markdown file.</p>

<h2>Prerequisites: app key and authorization</h2>

<p>First of all, you should acquire the app key &ndash; the entity required for all subsequent operations. Simply head over to <a href="https://trello.com/app-key">https://trello.com/app-key</a> to get this API key. Let&rsquo;s put it into the variable.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="nv">$apiKey</span> <span class="p">=</span> <span class="s2">&quot;LongSequenceOfCharsWhichIsBasicallyAnApiKey&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Real-world applications will need to ask each user to authorize the application, but as long as we are just playing with it locally, let&rsquo;s manually generate a token. Open this URL in your browser:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">trello</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">1</span><span class="p">/</span><span class="n">authorize</span><span class="k">?</span><span class="n">expiration</span><span class="p">=</span><span class="n">never</span><span class="p">&amp;</span><span class="n">scope</span><span class="p">=</span><span class="n">read</span><span class="p">&amp;</span><span class="n">response_type</span><span class="p">=</span><span class="n">token</span><span class="p">&amp;</span><span class="n">name</span><span class="p">=</span><span class="n">Server</span><span class="k">%</span><span class="n">20Token</span><span class="p">&amp;</span><span class="n">key</span><span class="p">=&lt;</span><span class="n">PASTE_ABOVE_KEY_HERE</span><span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that we specify the expiration term (never) and the token scope (read only) here. Copy the token when it appears on the page and save into another variable.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="nv">$token</span> <span class="p">=</span> <span class="s2">&quot;EvenLongerSequenceOfCharsWhichIsGuessWhatRightTheToken&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll need both values for any REST API request, so let&rsquo;s make our life easier:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="nv">$authSuffix</span> <span class="p">=</span> <span class="s2">&quot;key=$apiKey&amp;token=$token&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Get the Board ID to work with</h2>

<p>Okay, the preparations are over, and it&rsquo;s time to get the ID of the board we&rsquo;ll work with.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="nv">$response</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="n">-Uri</span> <span class="s2">&quot;https://api.trello.com/1/members/me?boards=open&amp;board_fields=name&amp;$authSuffix&quot;</span> <span class="n">-Method</span> <span class="n">Get</span>
</span><span class='line'><span class="nv">$boardId</span> <span class="p">=</span> <span class="nv">$response</span><span class="p">.</span><span class="n">Boards</span> <span class="p">|</span> <span class="n">where</span> <span class="n">name</span> <span class="o">-EQ</span> <span class="s2">&quot;Reading&quot;</span> <span class="p">|</span> <span class="n">select</span> <span class="n">-ExpandProperty</span> <span class="n">id</span>
</span></code></pre></td></tr></table></div></figure>


<p>The URL instructs the API to get all my open boards, which is then piped through <em>where</em> filter to get the one called &ldquo;Reading&rdquo;.</p>

<h2>Get the Labels used on the Board</h2>

<p>When I finish a book, I mark it with one of the following labels:</p>

<ul>
<li>Green:    Recommended</li>
<li>Blue:     Indifferent</li>
<li>Yellow:   OK for one-time reading</li>
<li>Red:      Waste of time</li>
</ul>


<p>We&rsquo;ll format the subheaders of each book review depending on the label it has. For instance, recommended books will be highlighted in <strong>bold</strong>, while clearly not recommended will be <del>struck though</del>. Let&rsquo;s get the list of those labels:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="nv">$response</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="n">-Uri</span> <span class="s2">&quot;https://api.trello.com/1/boards/</span><span class="si">$(</span><span class="err">$</span><span class="si">boardId)</span><span class="s2">?labels=all&amp;label_fields=color&amp;$authSuffix&quot;</span> <span class="n">-Method</span> <span class="n">Get</span>
</span><span class='line'><span class="nv">$labels</span> <span class="p">=</span> <span class="nv">$response</span><span class="p">.</span><span class="n">Labels</span> <span class="p">|</span> <span class="nb">Convert-ArrayToHashTable</span>
</span></code></pre></td></tr></table></div></figure>


<p>As a result, we have a hashtable &ndash; <em>LabelId : LabelColor</em>.</p>

<h2>Get the  List ID containing the Cards</h2>

<p>Trello cards live inside the lists, so let&rsquo;s get the <em>Done</em> list. As long as I know that the necessary list is the last one, it&rsquo;s a bit easier scripted:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="nv">$response</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="n">-Uri</span> <span class="s2">&quot;https://api.trello.com/1/boards/</span><span class="si">$(</span><span class="err">$</span><span class="si">boardId)</span><span class="s2">?lists=open&amp;list_fields=id,name&amp;$authSuffix&quot;</span> <span class="n">-Method</span> <span class="n">Get</span>
</span><span class='line'><span class="nv">$listId</span> <span class="p">=</span> <span class="nv">$response</span><span class="p">.</span><span class="n">Lists</span> <span class="p">|</span> <span class="n">select</span> <span class="n">-Last</span> <span class="n">1</span> <span class="n">-ExpandProperty</span> <span class="n">id</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Get the Cards from the List</h2>

<p>Now, when we have the list ID, we are just one call away from getting the collection of cards. Note that we only get necessary fields &ndash; in this case <strong>Title</strong> (subheader), <strong>Label</strong> (subheader formatting) and <strong>Description</strong> (actual text of the review).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="nv">$response</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="n">-Uri</span> <span class="s2">&quot;https://api.trello.com/1/lists/</span><span class="si">$(</span><span class="err">$</span><span class="si">listId)</span><span class="s2">?cards=all&amp;card_fields=name,desc,idLabels&amp;$authSuffix&quot;</span> <span class="n">-Method</span> <span class="n">Get</span>
</span><span class='line'><span class="nv">$cards</span> <span class="p">=</span> <span class="nv">$response</span><span class="p">.</span><span class="n">Cards</span> <span class="p">|</span> <span class="n">select</span> <span class="err">@</span><span class="p">{</span><span class="n">Name</span><span class="p">=</span><span class="s2">&quot;Title&quot;</span><span class="err">;</span>       <span class="n">Expression</span><span class="p">={</span><span class="nv">$_</span><span class="p">.</span><span class="n">name</span><span class="p">}},</span>
</span><span class='line'>                                  <span class="err">@</span><span class="p">{</span><span class="n">Name</span><span class="p">=</span><span class="s2">&quot;Label&quot;</span><span class="err">;</span>       <span class="n">Expression</span><span class="p">={</span><span class="nv">$labels</span><span class="p">[</span><span class="nv">$_</span><span class="p">.</span><span class="n">idLabels</span><span class="p">[</span><span class="n">0</span><span class="p">]]}},</span>
</span><span class='line'>                                  <span class="err">@</span><span class="p">{</span><span class="n">Name</span><span class="p">=</span><span class="s2">&quot;Description&quot;</span><span class="err">;</span> <span class="n">Expression</span><span class="p">={</span><span class="nv">$_</span><span class="p">.</span><span class="n">desc</span><span class="p">}}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>And a bit of formatting magic for dessert</h2>

<p>Finally, the collection of cards is transformed to become a nicely formatted Markdown document:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="nb">Convert-TableToMarkdown</span> <span class="nv">$cards</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the script, and you&rsquo;ll get a markdown document, similar to this one:</p>

<p><img src="/images/february2018/result_markdown.png"></p>

<h2>The full listing of the PowerShell script</h2>

<p>Here is the script I ended up with, including some under-the-hood formatting magic:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="k">Function</span> <span class="nb">Convert-ArrayToHashTable</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">begin</span> <span class="p">{</span> <span class="nv">$hash</span> <span class="p">=</span> <span class="err">@</span><span class="p">{}</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">process</span> <span class="p">{</span> <span class="nv">$hash</span><span class="p">[</span><span class="nv">$_</span><span class="p">.</span><span class="n">id</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">color</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$hash</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nb">Get-WrapperByLabel</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'>  <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$true</span><span class="p">)]</span> <span class="nv">$label</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">switch</span> <span class="p">(</span><span class="nv">$label</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="s2">&quot;red&quot;</span>    <span class="p">{</span> <span class="s2">&quot;~~&quot;</span> <span class="p">}</span>
</span><span class='line'>      <span class="s2">&quot;green&quot;</span>  <span class="p">{</span> <span class="s2">&quot;**&quot;</span> <span class="p">}</span>
</span><span class='line'>      <span class="s2">&quot;blue&quot;</span>   <span class="p">{</span> <span class="s2">&quot;*&quot;</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">Default</span> <span class="p">{</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">Function</span> <span class="nb">Convert-TableToMarkdown</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'>  <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$true</span><span class="p">)]</span> <span class="nv">$books</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nv">$filePath</span> <span class="p">=</span> <span class="s2">&quot;$PSScriptRoot\result.md&quot;</span>
</span><span class='line'>  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$book</span> <span class="k">in</span> <span class="nv">$books</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$wrapper</span> <span class="p">=</span> <span class="nb">Get-WrapperByLabel</span> <span class="nv">$book</span><span class="p">.</span><span class="n">Label</span>
</span><span class='line'>    <span class="s2">&quot;## $wrapper</span><span class="si">$(</span><span class="err">$</span><span class="si">book.Title)</span><span class="s2">$wrapper&quot;</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="n">-FilePath</span> <span class="nv">$filePath</span> <span class="n">-Encoding</span> <span class="n">unicode</span> <span class="n">-Append</span>
</span><span class='line'>    <span class="s2">&quot;&quot;</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="n">-FilePath</span> <span class="nv">$filePath</span> <span class="n">-Encoding</span> <span class="n">unicode</span> <span class="n">-Append</span>
</span><span class='line'>    <span class="s2">&quot;</span><span class="si">$(</span><span class="err">$</span><span class="si">book.Description)</span><span class="s2">&quot;</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="n">-FilePath</span> <span class="nv">$filePath</span> <span class="n">-Encoding</span> <span class="n">unicode</span> <span class="n">-Append</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Head over to https://trello.com/app-key to get this API key</span>
</span><span class='line'><span class="nv">$apiKey</span> <span class="p">=</span> <span class="s2">&quot;LongSequenceOfCharsWhichIsBasicallyAnApiKey&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Use this shortcut for local test code: https://trello.com/1/authorize?expiration=never&amp;scope=read&amp;response_type=token&amp;name=Server%20Token&amp;key=&lt;PASTE_ABOVE_KEY_HERE&gt;</span>
</span><span class='line'><span class="nv">$token</span> <span class="p">=</span> <span class="s2">&quot;EvenLongerSequenceOfCharsWhichIsGuessWhatRightTheToken&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># shape the authentication suffix to append to each URI in REST calls</span>
</span><span class='line'><span class="nv">$authSuffix</span> <span class="p">=</span> <span class="s2">&quot;key=$apiKey&amp;token=$token&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># get the ID of the target board</span>
</span><span class='line'><span class="nv">$response</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="n">-Uri</span> <span class="s2">&quot;https://api.trello.com/1/members/me?boards=open&amp;board_fields=name&amp;$authSuffix&quot;</span> <span class="n">-Method</span> <span class="n">Get</span>
</span><span class='line'><span class="nv">$boardId</span> <span class="p">=</span> <span class="nv">$response</span><span class="p">.</span><span class="n">Boards</span> <span class="p">|</span> <span class="n">where</span> <span class="n">name</span> <span class="o">-EQ</span> <span class="s2">&quot;Reading&quot;</span> <span class="p">|</span> <span class="n">select</span> <span class="n">-ExpandProperty</span> <span class="n">id</span>
</span><span class='line'>
</span><span class='line'><span class="c"># get the labels used on the board</span>
</span><span class='line'><span class="nv">$response</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="n">-Uri</span> <span class="s2">&quot;https://api.trello.com/1/boards/</span><span class="si">$(</span><span class="err">$</span><span class="si">boardId)</span><span class="s2">?labels=all&amp;label_fields=color&amp;$authSuffix&quot;</span> <span class="n">-Method</span> <span class="n">Get</span>
</span><span class='line'><span class="nv">$labels</span> <span class="p">=</span> <span class="nv">$response</span><span class="p">.</span><span class="n">Labels</span> <span class="p">|</span> <span class="nb">Convert-ArrayToHashTable</span>
</span><span class='line'>
</span><span class='line'><span class="c"># get the last list (which contains the items I&#39;m done reading)</span>
</span><span class='line'><span class="nv">$response</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="n">-Uri</span> <span class="s2">&quot;https://api.trello.com/1/boards/</span><span class="si">$(</span><span class="err">$</span><span class="si">boardId)</span><span class="s2">?lists=open&amp;list_fields=id,name&amp;$authSuffix&quot;</span> <span class="n">-Method</span> <span class="n">Get</span>
</span><span class='line'><span class="nv">$listId</span> <span class="p">=</span> <span class="nv">$response</span><span class="p">.</span><span class="n">Lists</span> <span class="p">|</span> <span class="n">select</span> <span class="n">-Last</span> <span class="n">1</span> <span class="n">-ExpandProperty</span> <span class="n">id</span>
</span><span class='line'>
</span><span class='line'><span class="c"># get the list of cards (necessary fields only)</span>
</span><span class='line'><span class="nv">$response</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="n">-Uri</span> <span class="s2">&quot;https://api.trello.com/1/lists/</span><span class="si">$(</span><span class="err">$</span><span class="si">listId)</span><span class="s2">?cards=all&amp;card_fields=name,desc,idLabels&amp;$authSuffix&quot;</span> <span class="n">-Method</span> <span class="n">Get</span>
</span><span class='line'><span class="nv">$cards</span> <span class="p">=</span> <span class="nv">$response</span><span class="p">.</span><span class="n">Cards</span> <span class="p">|</span> <span class="n">select</span> <span class="err">@</span><span class="p">{</span><span class="n">Name</span><span class="p">=</span><span class="s2">&quot;Title&quot;</span><span class="err">;</span>       <span class="n">Expression</span><span class="p">={</span><span class="nv">$_</span><span class="p">.</span><span class="n">name</span><span class="p">}},</span>
</span><span class='line'>                                  <span class="err">@</span><span class="p">{</span><span class="n">Name</span><span class="p">=</span><span class="s2">&quot;Label&quot;</span><span class="err">;</span>       <span class="n">Expression</span><span class="p">={</span><span class="nv">$labels</span><span class="p">[</span><span class="nv">$_</span><span class="p">.</span><span class="n">idLabels</span><span class="p">[</span><span class="n">0</span><span class="p">]]}},</span>
</span><span class='line'>                                  <span class="err">@</span><span class="p">{</span><span class="n">Name</span><span class="p">=</span><span class="s2">&quot;Description&quot;</span><span class="err">;</span> <span class="n">Expression</span><span class="p">={</span><span class="nv">$_</span><span class="p">.</span><span class="n">desc</span><span class="p">}}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">Convert-TableToMarkdown</span> <span class="nv">$cards</span>
</span></code></pre></td></tr></table></div></figure>


<p>P.S. The <a href="https://trello.com">Trello</a> REST API is clear, concise and well-documented <a href="https://developers.trello.com/reference">here</a>. Great job!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/11/06/vsts-and-teamcity-commit-status-publisher/">VSTS and TeamCity Commit Status Publisher</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-11-06T22:24:00+02:00" pubdate data-updated="true">Nov 6<span>th</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Some time ago VSTS team added a feature called <a href="https://docs.microsoft.com/en-us/vsts/release-notes/2017/aug-04-team-services#pull-request-status-extensibility-in-public-preview">Pull Request Status Extensibility</a>. It unlocked the door for the external services to post custom statuses to the pull requests created in Git repositories hosted in VSTS. Once the status is posted, it is possible to make a branching policy out of it, and this fact makes it a powerful feature.</p>

<blockquote><p>According to the <a href="https://docs.microsoft.com/en-us/vsts/release-notes/index">VSTS Feature Timeline</a> Pull Request Status Extensibility will arrive in On-Prem TFS 2018 RC1 and future.</p></blockquote>

<p>Fortunately, TeamCity has just added the option to send pull request statuses to its <a href="https://confluence.jetbrains.com/display/TCD10/Commit+Status+Publisher">Commit Status Publisher</a> in the most recent build of the version 2017.2.</p>

<blockquote><p>At the moment of writing this post, the version 2017.2 is still an EAP, and I&rsquo;ll use <a href="https://blog.jetbrains.com/teamcity/2017/11/teamcity-2017-2-eap4-is-available/">2017.2 EAP4</a> as the first build the feature has arrived with.</p></blockquote>

<p>These two pieces assemble in a nice picture where you can host your project in VSTS while keeping the build part entirely in TeamCity. In this post, I&rsquo;ll guide you through the steps required to configure this beautiful setup.</p>

<h2>TeamCity: basic setup of the build project</h2>

<p>To begin with, we&rsquo;ll add <a href="https://confluence.jetbrains.com/display/TCD10/Integrating+TeamCity+with+VCS+Hosting+Services#IntegratingTeamCitywithVCSHostingServices-ConnectingtoVisualStudioTeamServices">a connection to VSTS</a> in TeamCity. It is not required, but helps a lot in the further configuration of VCS root and build features. Navigate to <strong>Administration > &lt;Root Project&gt; > Connections</strong> and click &ldquo;Add Connection&rdquo; button:</p>

<p><img src="/images/november2017/tc_connection.png"></p>

<p>Now, let&rsquo;s create a new build project. Thanks to the connection configured prior to this step, the VCS root configuration is as easy as clicking a Visual Studio icon:</p>

<p><img src="/images/november2017/tc_vcsroot.png"></p>

<p>Choose the repository we&rsquo;d like to target and TeamCity will form the proper clone URL. Note that Branch Specification field is set to watch pull requests too.</p>

<p>For the sake of this demo the build project itself is quite simple: it contains just one build configuration, which in its turn consists of a single PowerShell build step faking the real build process by several seconds sleep. There&rsquo;s also a VCS trigger to run the build on the changes in default branch (<code>+:&lt;default&gt;</code>) as well as pull request merges (<code>+:pull/*/merge</code>).</p>

<p>Finally, we should configure the Commit Status Publisher, which does all the magic. Switch to the Build Feature on the left pane, and click &ldquo;Add Build Feature&rdquo; button:</p>

<p><img src="/images/november2017/tc_commit_status_publisher.png"></p>

<p>Note the checkbox that hides in the Advanced Options view. It should be turned on in order to enable pull request status publishing.</p>

<blockquote><p>Ideally, you should generate another personal access token in VSTS with only <code>Code (status)</code> and <code>Code (read)</code> scopes specified. However, being lazy, I&rsquo;ve just clicked the <strong>magic wand</strong> icon and TeamCity pulled the <strong>all-scopes</strong> access token from the connection.</p></blockquote>

<h2>VSTS: creating a pull request with status from TeamCity</h2>

<p>Now, when we&rsquo;re done with TeamCity configuration, let&rsquo;s go ahead and create a pull request in out VSTS Git repository. When TeamCity detects the change, it starts building the pull request. At the same time, the pull request view in VSTS displays appropriate status:</p>

<p><img src="/images/november2017/vsts_pr_status_building.png"></p>

<p>Once the build has completed, the status is refreshed:</p>

<p><img src="/images/november2017/vsts_pr_status_success.png"></p>

<p>If you click the link, it navigates to the completed build page in TeamCity:</p>

<p><img src="/images/november2017/tc_pr_success.png"></p>

<h2>VSTS: Make branch policy out of the TeamCity build status</h2>

<p>As long as the external service has published its status to the pull request once, it is possible to configure it to serve as a branch policy for this and all other pull requests in this repository. Let&rsquo;s do this now.</p>

<p>Navigate to the branch policies of the <code>master</code> branch and click &ldquo;Add Service&rdquo; in &ldquo;Require approval from external services&rdquo; section:</p>

<p><img src="/images/november2017/vsts_branch_policy.png"></p>

<p>Choose the target service from the dropdown (its name is combined of TeamCity build project and configuration) and modify other options according to your needs. Note that it is possible to configure the service the way it behaves as a normal branch policy. For example, the status can be required and will expire when the source branch gets an update:</p>

<p><img src="/images/november2017/vsts_add_service.png"></p>

<p>Finally, click Save and push some other change to the existing pull request. As soon as the pull request is updated, the <code>Status</code> section disappears and a new policy is displayed. It stays in the waiting mode until the TeamCity build is started:</p>

<p><img src="/images/november2017/vsts_policy_new.png"></p>

<p>Once the build is started, the policy status changes to <code>Pending</code>:</p>

<p><img src="/images/november2017/vsts_policy_building.png"></p>

<p>Finally, when the build is done, it is also reflected on the custom policy status:</p>

<p><img src="/images/november2017/vsts_policy_success.png"></p>

<p>Similar to the pull request status behavior, it is possible to click the link and navigate to the build view in TeamCity.</p>

<h2>TeamCity: build normal branches and post the status back to VSTS</h2>

<p>When we merge the pull request, the build of the master branch is triggered in TeamCity. If you switch to the Branches view in VSTS, you can see the <code>In Progress</code> type of icon in the Build column of the master branch:</p>

<p><img src="/images/november2017/vsts_master_building.png"></p>

<p>Once the build is completed, the icon changes to the appropriate state (<code>Success</code> in our case):</p>

<p><img src="/images/november2017/vsts_master_success.png"></p>

<h2>Conclusion</h2>

<p>In this article, we&rsquo;ve quickly run through the steps required to configure close integration between VSTS Git repository and TeamCity build project. Note that I haven&rsquo;t written a single line of code for this to happen. This setup might be useful for those projects that have extensive build configuration in TeamCity, but would like to benefit from the fantastic pull request user experience in VSTS.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/27/err-connection-refused/">ERR_CONNECTION_REFUSED</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-08-27T22:19:00+03:00" pubdate data-updated="true">Aug 27<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today I have faced with the problem installing Basic Authentication feature into the Web Server role on Windows 2012 R2. The wizard kept throwing various errors, including scary OutOfMemoryException. A quick googling that has found a suggestion to run <code>netsh http show iplisten</code> and add 127.0.0.1 (aka Home Sweet Home) to the list if it&rsquo;s not there. I gave it a try without giving it a thought first.</p>

<p>The initial problem has not been solved &ndash; the wizard kept failing to add that feature, and I finally resolved it with the mighty PowerShell:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="nb">Import-Module</span> <span class="n">ServerManager</span>
</span><span class='line'><span class="nb">Add-WindowsFeature</span> <span class="n">Web-Basic-Auth</span>
</span></code></pre></td></tr></table></div></figure>


<p>Later on I had to browse for a website hosted on that server, and I suddenly saw <em>This webpage is not available</em> message. Hmm&hellip; First off, I&rsquo;ve verified that the website works locally &ndash; and it did. This gave me another hint and I checked whether the bindings are set up correctly. And they were! Finally, I started to think that it&rsquo;s Basic Authentication feature to blame &ndash; yeah, I know, that was a stupid assumption, but hey, stupid assumptions feel very comfortable for brain when it faces with the magic&hellip;</p>

<p>Anyway, fortunately I recalled that quick dumb action I did with netsh, and the magic has immediately turned into the dust, revealing someone&rsquo;s ignorance&hellip; Turns out, if <code>iplisten</code> does not list anything, it means listen to everything, any IP address. When you add something there, it starts listening to that IP address only.</p>

<p>Thus, it was all resolved by deleting 127.0.0.1 from that list with <code>netsh http delete iplisten ipaddress=127.0.0.1</code>.</p>

<p>Want some quick conclusion? <strong>Think first, then act!!!</strong></p>

<blockquote><p>Written with <a href="https://stackedit.io/">StackEdit</a>.</p></blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/24/build-queue-starvation-in-cc-dot-net/">Build Queue Starvation in CC.NET</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-11-24T22:54:00+02:00" pubdate data-updated="true">Nov 24<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I&rsquo;ve come across an interesting behavior in CruiseControl.NET in regards to the build queues and priorities.</p>

<p>If there are many projects on one server, and the server it not quite powerful, and more than one build queue is configured, and (that&rsquo;s the last one) these build queues have different priorities, you might end up in a situation when CC.NET checks for modifications the same set of projects all over again, and never starts an actual build. If you add the projects from that server to the CCTray, you can observe the number of projects queued for the build has reached a certain number and never decreases.</p>

<p>This phenomenon is call &ldquo;build queue starvation&rdquo;. It was <a href="http://www.damirscorner.com/AvoidingQueueStarvationInCruiseControlNET.aspx">described and explained by Damir Arh in his blog</a>.</p>

<p>Let me summarize the main idea.</p>

<p>When one build queue has a higher priority than another queue, CC.NET favors the projects from the first queue when scheduling for modifications check. Now imagine that a trigger of the projects from the higher priority queue is quite small and the number of such projects is big enough. This leads to the situation when the first project in high priority queue is scheduled for build the second round before the last project in that queue has built its first time.</p>

<p>As a result, the lower priority queue is &ldquo;starving&rdquo; &ndash; none of its projects ever gets a chance to be built. The fix suggested in the link above suits my needs &ndash; the trigger interval has just been increased.</p>

<p>I should say it&rsquo;s not easy to google that if you&rsquo;re not familiar with the term &ldquo;build queue starvation&rdquo;. Besides, CC.NET doesn&rsquo;t feel bad in this situation, and hence doesn&rsquo;t help with any warnings &ndash; it just does its job iterating the queue and following the instructions.</p>

<blockquote><p>Written with <a href="https://stackedit.io/">StackEdit</a>.</p></blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/01/setting-up-an-existing-blog-on-octopress/">Setting Up an Existing Blog on Octopress</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-01T00:18:00+03:00" pubdate data-updated="true">Aug 1<span>st</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Ok, it took me some time and efforts to set up the environment for blogging. Consider this post as a quick instruction to myself for the next time I&rsquo;ll have to do this.</p>

<p>So, there&rsquo;s an existing blog created with <a href="http://octopress.org/">Octopress</a>, hosted on <a href="https://github.com/">Github</a>. The task is to setup a brand new machine to enable smooth blogging experience.</p>

<blockquote><p>Note: just in case you have to create a blog from scratch, follow the official <a href="http://octopress.org/docs/setup/">Octopress docs</a>, it&rsquo;s quite clear.</p></blockquote>

<p>First of all, you should install Ruby. Octopress docs recommend using either rbenv or RVM for this. Both words sound scary, hence don&rsquo;t hesitate to take the easy path and download an installer from <a href="http://dl.bintray.com/oneclick/rubyinstaller/rubyinstaller-1.9.3-p545.exe?direct">here</a>. At the last page of the installation wizard, choose to add Ruby binaries to the <code>PATH</code>:</p>

<p><img src="/images/july2014/install_ruby.png"></p>

<p>When installer completes, check the installed version:</p>

<pre><code>ruby --version
</code></pre>

<p>Then, clone the repo with the blog from Github. Instead of calling <code>rake setup_github_pages</code> as suggested by the Octopress docs, follow these steps found <a href="http://tech.paulcz.net/2012/12/creating-a-github-pages-blog-with-octopress.html">here</a>. Let&rsquo;s assume we&rsquo;ve done that into <code>blog</code> folder:</p>

<pre><code>git clone git@github.com:username/username.github.com.git blog
cd blog
git checkout source
mkdir _deploy
cd _deploy
git init
git remote add origin git@github.com:username/username.github.com.git
git pull origin master
cd ..
</code></pre>

<p>Now do the following:</p>

<pre><code>gem install bundler
bundle install
</code></pre>

<p>This should pull all the dependencies required for the Octopress engine. Here&rsquo;s where I faced with the first inconsistency in the docs &ndash; one of the dependencies (fast-stemmer) fails to install without <a href="https://github.com/downloads/oneclick/rubyinstaller/DevKit-tdm-32-4.5.2-20111229-1559-sfx.exe">the DevKit</a>. Download it and run the installer. The installation process is documented <a href="https://github.com/oneclick/rubyinstaller/wiki/Development-Kit">here</a>, but the quickest way is:</p>

<ul>
<li>self-extract the archive</li>
<li><code>cd</code> to that folder</li>
<li>run <code>ruby dk.rb init</code></li>
<li>then run <code>ruby dk.rb install</code></li>
</ul>


<p>After this, re-run the <code>bundle install</code> command.</p>

<p>Well, at this point you should be able to create new posts with <code>rake new_post[title]</code> command. Generate the resulting HTML with <code>rake generate</code> and preview it with <code>rake preview</code> to make sure it produces what you expect.</p>

<p><strong><em>An important note about syntax highlighting</em></strong></p>

<p>Octopress uses <a href="http://pygments.org/">Pygments</a> to highlight the code. This is a <a href="https://www.python.org/">Python</a> thing, and obviously you should install Python for this to work. Choose <a href="https://www.python.org/ftp/python/2.7.8/python-2.7.8.msi">2.x version of Python</a> &ndash; the 3.x version doesn&rsquo;t work. This is important: you won&rsquo;t be able to generate HTML from MARKDOWN otherwise.</p>

<p>That&rsquo;s it! Hope this will save me some time in future.</p>

<blockquote><p>And by the way, this all is written with <a href="https://stackedit.io/">StackEdit</a> &ndash; a highly recommended online markdown editor.</p></blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/31/migrate-attachments-from-ontime-to-tfs/">Migrate Attachments From OnTime to TFS</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-31T23:32:00+03:00" pubdate data-updated="true">Jul 31<span>st</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When you move from one bug tracking system to another, the accuracy of the process is very important. A single missing point can make a work item useless. An attached image is often worth a thousand words. Hence, today&rsquo;s post is about migrating attachments from <a href="http://www.axosoft.com/">OnTime</a> to <a href="http://en.wikipedia.org/wiki/Team_Foundation_Server">TFS</a>.</p>

<blockquote><p>NOTE: The samples in this post rely on OnTime SDK, which was replaced by a <a href="http://developer.axosoft.com/api">brand new REST API</a>.</p></blockquote>

<p>OnTime SDK is a set of web services, and each &ldquo;area&rdquo; is usually covered by one or a number of web services. The operations with attachments are grouped in <code>/sdk/AttachmentService.asmx</code> web service.</p>

<p>So, the first thing to do is to grab all attachments of the OnTime defect:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="kt">var</span> <span class="n">rawAttachments</span> <span class="p">=</span> <span class="n">_attachmentService</span><span class="p">.</span><span class="n">GetAttachmentsList</span><span class="p">(</span><span class="n">securityToken</span><span class="p">,</span> <span class="n">AttachmentSourceTypes</span><span class="p">.</span><span class="n">Defect</span><span class="p">,</span> <span class="n">defect</span><span class="p">.</span><span class="n">DefectId</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>This method returns a <code>DataSet</code>, and you&rsquo;ll have to enumerate its rows to grab the useful data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="kt">var</span> <span class="n">attachments</span> <span class="p">=</span> <span class="n">rawAttachments</span><span class="p">.</span><span class="n">Tables</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">AsEnumerable</span><span class="p">();</span>
</span><span class='line'><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">attachment</span> <span class="k">in</span> <span class="n">attachments</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// wi is a TFS work item object</span>
</span><span class='line'>  <span class="n">wi</span><span class="p">.</span><span class="n">Attachments</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">GetAttachment</span><span class="p">(</span><span class="n">attachment</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, let&rsquo;s take a look at the <code>GetAttachment</code> method, which actually does the job. It accepts the <code>DataRow</code>, and returns the TFS <code>Attachment</code> object:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">private</span> <span class="n">Attachment</span> <span class="nf">GetAttachment</span><span class="p">(</span><span class="n">DataRow</span> <span class="n">attachmentRow</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">onTimeAttachment</span> <span class="p">=</span> <span class="n">_attachmentService</span><span class="p">.</span><span class="n">GetByAttachmentId</span><span class="p">(</span><span class="n">securityToken</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">attachmentRow</span><span class="p">[</span><span class="s">&quot;AttachmentId&quot;</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">var</span> <span class="n">tempFile</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="n">GetTempPath</span><span class="p">(),</span> <span class="n">onTimeAttachment</span><span class="p">.</span><span class="n">FileName</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">File</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">tempFile</span><span class="p">))</span>
</span><span class='line'>    <span class="n">File</span><span class="p">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">tempFile</span><span class="p">);</span>
</span><span class='line'>  <span class="n">File</span><span class="p">.</span><span class="n">WriteAllBytes</span><span class="p">(</span><span class="n">tempFile</span><span class="p">,</span> <span class="n">onTimeAttachment</span><span class="p">.</span><span class="n">FileData</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nf">Attachment</span><span class="p">(</span><span class="n">tempFile</span><span class="p">,</span> <span class="n">onTimeAttachment</span><span class="p">.</span><span class="n">Description</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Couple of things to notice here:</p>

<ul>
<li>you have to call another web method to pull binary data of the attachment</li>
<li>OnTime attachment metadata is rather useful and can be moved as is to TFS, for instance, attachment description</li>
</ul>


<p>Finally, when a new attachment is added to the TFS work item, &ldquo;increment&rdquo; the <code>ChangedDate</code> of the work item before saving it. The TFS server often refuses saving work item data in case the previous revision has exactly the same date/time stamp. Like this (always works):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="n">wi</span><span class="p">[</span><span class="n">CoreField</span><span class="p">.</span><span class="n">ChangedDate</span><span class="p">]</span> <span class="p">=</span> <span class="n">wi</span><span class="p">.</span><span class="n">ChangedDate</span><span class="p">.</span><span class="n">AddSeconds</span><span class="p">(</span><span class="m">5</span><span class="p">);</span>
</span><span class='line'><span class="n">wi</span><span class="p">.</span><span class="n">Save</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hope it&rsquo;s useful. Good luck!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/03/nant-task-behaves-differently-in-092/">NAnt <copy> Task Behaves Differently in 0.92 and Prior Versions</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-03T11:35:00+02:00" pubdate data-updated="true">Jan 3<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
<div dir="ltr" style="text-align: left;" trbidi="on">If you need to copy a folder together with all its contents to another folder in NAnt, you would typically write something like this:<br /><div class="wlWriterEditableSmartContent" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:4960f8c7-91c0-4ec8-8979-ab0fde40976f" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre class="brush: xml;wrap-lines:false;">&lt;copy todir="${target}"&gt;<br />  &lt;fileset basedir="${source}" /&gt;<br />&lt;/copy&gt;</pre></div>It turns out this code works correctly in NAnt 0.92 Alpha and above. The output is expected:<br /><div class="wlWriterEditableSmartContent" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:871b39e6-e873-499d-bcab-3017221ef94f" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre class="brush: xml;">[copy] Copying 1 directory to '...'.</pre></div>However, the same code doesnt work in prior versions of NAnt, for instance, 0.91. The output is as follows (only in debug+ mode):<br /><div class="wlWriterEditableSmartContent" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:52c67d5f-bfa3-485c-b3e4-c2ec64294d6e" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre class="brush: xml;">[copy] Copying 0 files to '...'.</pre></div>Obviously, <a href="https://github.com/nant/nant/issues/11" target="_blank">the issue was fixed in 0.92</a>, so the best recommendation would be to upgrade NAnt toolkit. However, if this is not an option for some reason, the following code seems to work correctly for any version:<br /><div class="wlWriterEditableSmartContent" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:566e2066-71ca-4983-a0b5-40d35ce3f5bb" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre class="brush: xml;">&lt;copy todir="${target}"&gt;<br />  &lt;fileset basedir="${source}"&gt;<br />    &lt;include name="**/*" /&gt;<br />  &lt;/fileset&gt;<br />&lt;/copy&gt;</pre></div>Hope this saves you some time.</div></div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/11/19/possible-source-of-signtool-bad-format/">Possible Source of the Signtool &#8216;Bad Format&#8217; 0x800700C1 Problem</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-19T17:26:00+02:00" pubdate data-updated="true">Nov 19<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
<div dir="ltr" style="text-align: left;" trbidi="on">Today I have faced with a weird problem. The operation to sign the EXE file (actually, an installation package) with a valid certificate failed with the following error:<br /><div class="wlWriterEditableSmartContent" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:bc6106fa-3bf6-4da8-a4b3-7f14ff86ba80" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre class="brush: xml;">[exec] SignTool Error: SignedCode::Sign returned error: 0x800700C1<br />[exec] Either the file being signed or one of the DLL specified by /j switch is not a valid Win32 application.<br />[exec] SignTool Error: An error occurred while attempting to sign: D:\output\setup.exe</pre></div>This kind of error is usually an indication of a format incompatibility, <a href="http://technet.microsoft.com/en-us/library/cc782541(WS.10).aspx" target="_blank">when the bitness of the signtool.exe and the bitness of the EXE in question don&#8217;t correspond</a>. However, this was not the case.<br /><br />It turns out that the original EXE file was generated incorrectly because of the lack of disk space. That&#8217;s why it was broken and was recognized by the signtool like a bad format file. After disk cleanup everything worked perfectly and the EXE file was signed correctly.<br /><br />Hope this saves someone some time. </div></div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/29/a-solution-can-build-fine-from-inside/">A Solution Can Build Fine From Inside the Visual Studio, but Fail to Build With msbuild.exe</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-29T16:35:00+02:00" pubdate data-updated="true">Oct 29<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
<div dir="ltr" style="text-align: left;" trbidi="on">Today I have faced with an interesting issue. Although I failed to reproduce it on a fresh new project, I think this info might be useful for others.<br />I have a solution which was upgraded from targeting .NET Framework 2.0 to .NET Framework 3.5. Ive got a patch from a fellow developer to apply to one of the projects of that solution. The patch adds new files as well as modifies existing ones. After the patch application, the solution is successfully built from inside the Visual Studio, but fails to build from the command line with msbuild.exe. The error thrown states that <br /><div class="wlWriterEditableSmartContent" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:5c70df5d-f802-466e-9713-c35fabc6dfbb" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre class="brush: c#;">The type or namespace name 'Linq' does not exist in the namespace 'System' . </pre></div>The msbuild version is 3.5:<br /><div class="wlWriterEditableSmartContent" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:5d034399-054f-4ebd-aabb-73bf9dab56bf" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre class="brush: c#;">[exec] Microsoft (R) Build Engine Version 3.5.30729.5420<br />[exec] [Microsoft .NET Framework, Version 2.0.50727.5456]<br />[exec] Copyright (C) Microsoft Corporation 2007. All rights reserved.</pre></div>It turns out <a href="http://connect.microsoft.com/VisualStudio/feedback/details/665406/using-system-linq-without-reference-to-system-core-compiles-in-vs-but-not-with-msbuild-exe" target="_blank">this issue has been met by other people</a>, and even reported to Microsoft. Microsoft suggested to use MSBuild.exe 4.0 to build VS 2010 projects. However, they confirmed it is possible to use MSBuild.exe 3.5&nbsp; - in this case a reference to System.Core (3.5.0.0) must be explicitly added to the csproj file.<br />If you try to add a reference to System.Core from inside the Visual Studio, youll get the error saying:<br /><div class="wlWriterEditableSmartContent" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:d25d09ad-d4a7-4cd3-8b89-6959ec9d1e60" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre class="brush: c#;">"A reference to 'System.Core' could not be added. This component is already automatically referenced by the build system"</pre></div>So, it seems that when you build a solution from inside the Visual Studio, it is capable to automatically load implicitly referenced assemblies. I suppose, MSBuild.exe 4.0 (and even SP1-patched MSBuild.exe 3.5?) can do this as well. Apparently, this has also <a href="http://blog.rlucas.net/bugfix/force-a-reference-to-system-core-in-visual-studio-2010/" target="_blank">turned out to be a known problem</a>  you cant add that reference from the IDE. Open csproj file in your favorite editor and add this:<br /><div class="wlWriterEditableSmartContent" id="scid:f32c3428-b7e9-4f15-a8ea-c502c7ff2e88:cd2bda3a-a055-467e-85d3-7913a99c7de4" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre class="brush: xml;">&lt;Reference Include="System.Core" /&gt;</pre></div>After this, the project builds fine in both VS and MSBuild.</div></div>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/03/25/use-cognitive-services-in-vsts-custom-branch-policies/">Use cognitive services in VSTS custom branch policies</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/02/20/transform-trello-list-into-markdown-file/">Transform Trello list into Markdown file</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/11/06/vsts-and-teamcity-commit-status-publisher/">VSTS and TeamCity Commit Status Publisher</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/27/err-connection-refused/">ERR_CONNECTION_REFUSED</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/24/build-queue-starvation-in-cc-dot-net/">Build queue starvation in CC.NET</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Yan Sklyarenko -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  










  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
